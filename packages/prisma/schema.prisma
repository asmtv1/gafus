generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Course {
  id             String           @id @default(cuid())
  name           String
  type           String           @unique @db.VarChar(50)
  description    String           @default("")
  equipment      String           @default("")
  trainingLevel  TrainingLevel
  shortDesc      String           @default("")
  duration       String
  logoImg        String
  isPrivate      Boolean          @default(false)
  isPaid         Boolean          @default(false)
  authorId       String
  avgRating      Float?
  videoUrl       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  showInProfile  Boolean          @default(true)
  priceRub       Decimal?         @db.Decimal(10, 2)
  isPersonalized Boolean          @default(false)
  awards         Award[]
  author         User             @relation(fields: [authorId], references: [id])
  access         CourseAccess[]
  reviews        CourseReview[]
  dayLinks       DayOnCourse[]
  favoritedBy    FavoriteCourse[]
  payments       Payment[]
  userCourses    UserCourse[]
  ofertaAcceptances OfertaAcceptance[]
}

model TrainingDay {
  id                   String        @id @default(cuid())
  title                String
  equipment            String        @default("")
  description          String        @default("")
  type                 String        @default("regular")
  authorId             String
  showCoursePathExport Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  dayLinks             DayOnCourse[]
  stepLinks            StepOnDay[]
  author               User          @relation(fields: [authorId], references: [id])
}

model Step {
  id                      String       @id @default(cuid())
  title                   String
  description             String       @default("")
  durationSec             Int?
  type                    StepType     @default(TRAINING)
  imageUrls               String[]     @default([])
  pdfUrls                 String[]     @default([])
  videoUrl                String?
  checklist               Json?
  requiresVideoReport     Boolean      @default(false)
  requiresWrittenFeedback Boolean      @default(false)
  hasTestQuestions        Boolean      @default(false)
  authorId                String
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @default(now())
  estimatedDurationSec    Int?
  examResults             ExamResult[]
  author                  User         @relation(fields: [authorId], references: [id])
  stepLinks               StepOnDay[]
}

model StepCategory {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  icon        String?
  order       Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  templates   StepTemplate[]

  @@index([order])
}

model StepTemplate {
  id                      String        @id @default(cuid())
  title                   String
  description             String        @default("")
  durationSec             Int?
  type                    StepType      @default(TRAINING)
  imageUrls               String[]      @default([])
  pdfUrls                 String[]      @default([])
  videoUrl                String?
  checklist               Json?
  requiresVideoReport     Boolean       @default(false)
  requiresWrittenFeedback Boolean       @default(false)
  hasTestQuestions        Boolean       @default(false)
  categoryId              String?
  tags                    String[]      @default([])
  isPublic                Boolean       @default(true)
  usageCount              Int           @default(0)
  authorId                String
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  estimatedDurationSec    Int?
  author                  User          @relation(fields: [authorId], references: [id])
  category                StepCategory? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isPublic])
  @@index([authorId])
}

model DayOnCourse {
  id            String         @id @default(cuid())
  courseId      String
  dayId         String
  order         Int
  course        Course         @relation(fields: [courseId], references: [id])
  day           TrainingDay    @relation(fields: [dayId], references: [id])
  diaryEntries  DiaryEntry[]
  userTrainings UserTraining[]

  @@unique([courseId, order])
  @@index([courseId, order])
}

model DiaryEntry {
  id            String      @id @default(cuid())
  userId        String
  dayOnCourseId String
  content       String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  dayOnCourse   DayOnCourse @relation(fields: [dayOnCourseId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOnCourseId])
  @@index([userId])
  @@index([dayOnCourseId])
}

model StepOnDay {
  id        String      @id @default(cuid())
  dayId     String
  stepId    String
  order     Int
  day       TrainingDay @relation(fields: [dayId], references: [id], onDelete: Cascade)
  step      Step        @relation(fields: [stepId], references: [id], onDelete: Cascade)
  userSteps UserStep[]

  @@unique([dayId, order])
  @@index([dayId, order])
}

model UserTraining {
  id               String         @id @default(cuid())
  userId           String
  dayOnCourseId    String
  status           TrainingStatus @default(NOT_STARTED)
  currentStepIndex Int?           @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now())
  steps            UserStep[]
  dayOnCourse      DayOnCourse    @relation(fields: [dayOnCourseId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id])

  @@unique([userId, dayOnCourseId])
}

model UserStep {
  id             String         @id @default(cuid())
  userTrainingId String
  stepOnDayId    String
  status         TrainingStatus @default(NOT_STARTED)
  paused         Boolean        @default(false)
  remainingSec   Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now())
  examResult     ExamResult?
  stepOnDay      StepOnDay      @relation(fields: [stepOnDayId], references: [id], onDelete: Cascade)
  userTraining   UserTraining   @relation(fields: [userTrainingId], references: [id], onDelete: Cascade)

  @@unique([userTrainingId, stepOnDayId])
}

model User {
  id                       String                 @id @default(cuid())
  username                 String                 @unique
  phone                    String                 @unique
  password                 String
  telegramId               String?                @unique
  isConfirmed              Boolean                @default(false)
  role                     UserRole               @default(USER)
  passwordResetRequestedAt DateTime?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @default(now())
  phoneChangeRequestedAt   DateTime?
  authoredCourses          Course[]
  courseAccesses           CourseAccess[]
  courseReviews            CourseReview[]
  diaryEntries             DiaryEntry[]
  diplomas                 Diploma[]
  reviewedExamResults      ExamResult[]           @relation("ExamResultReviewedBy")
  favoriteCourses          FavoriteCourse[]
  passwordResetTokens      PasswordResetToken[]
  payments                 Payment[]
  pets                     Pet[]
  phoneChangeTokens        PhoneChangeToken[]
  pushSubscriptions        PushSubscription[]
  reengagementCampaigns    ReengagementCampaign[]
  reengagementSettings     ReengagementSettings?
  refreshTokens            RefreshToken[]
  reminders                Reminder[]
  createdSteps             Step[]
  stepNotifications        StepNotification[]
  createdStepTemplates     StepTemplate[]
  trainerAIChats           TrainerAIChat[]
  trainerAIConfig          TrainerAIConfig?
  trainerNotes             TrainerNote[]          @relation("TrainerNotes")
  studentNotes             TrainerNoteStudent[]   @relation("StudentNotes")
  trainerVideos            TrainerVideo[]
  trainings                Training[]
  trainingAccesses         TrainingAccess[]
  createdDays              TrainingDay[]
  userCourses              UserCourse[]
  profile                  UserProfile?
  userTrainings            UserTraining[]
  userVideoProgresses      UserVideoProgress[]
  consentLogs              ConsentLog[]
  ofertaAcceptances        OfertaAcceptance[]
}

enum ConsentType {
  PERSONAL_DATA
  PRIVACY_POLICY
  DATA_DISTRIBUTION
}

enum ConsentLogStatus {
  PENDING
  COMPLETED
  FAILED
}

model ConsentLog {
  id             String          @id @default(cuid())
  tempSessionId  String
  consentType    ConsentType
  userId         String?
  user           User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  consentVersion String
  consentText    Json?
  consentDate    DateTime
  ipAddress      String?
  userAgent      String?
  formData       Json?
  status         ConsentLogStatus
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([tempSessionId, consentType])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([tempSessionId])
}

model TrainerVideo {
  id                  String              @id @default(cuid())
  trainerId           String
  relativePath        String
  originalName        String
  mimeType            String
  fileSize            Int
  durationSec         Int?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @default(now()) @updatedAt
  displayName         String?
  hlsManifestPath     String?
  transcodingStatus   TranscodingStatus   @default(PENDING)
  transcodedAt        DateTime?
  transcodingError    String?
  thumbnailPath       String?
  trainer             User                @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  userVideoProgresses UserVideoProgress[]

  @@index([trainerId], map: "idx_trainer_videos_trainer")
  @@index([transcodingStatus])
}

model UserVideoProgress {
  id              String       @id @default(cuid())
  userId          String
  videoId         String
  lastPositionSec Int
  updatedAt       DateTime     @updatedAt
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           TrainerVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model UserProfile {
  id        String    @id @default(cuid())
  userId    String    @unique
  fullName  String?
  birthDate DateTime?
  about     String?
  telegram  String?
  instagram String?
  website   String?
  avatarUrl String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Diploma {
  id        String    @id @default(cuid())
  userId    String
  title     String
  issuedBy  String?
  issuedAt  DateTime?
  url       String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Training {
  id        String           @id @default(cuid())
  userId    String
  name      String
  isPrivate Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  access    TrainingAccess[]
}

model UserCourse {
  userId          String
  courseId        String
  status          TrainingStatus @default(NOT_STARTED)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now())
  userDisplayName String?
  userGender      String?
  petName         String?
  petNameDat      String?
  petNameIns      String?
  petGender       String?
  petNameGen      String?
  petNameAcc      String?
  petNamePre      String?
  course          Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, courseId])
}

model Pet {
  id        String   @id @default(cuid())
  ownerId   String
  name      String
  type      PetType
  breed     String
  birthDate DateTime
  heightCm  Float?
  weightKg  Float?
  photoUrl  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  awards    Award[]
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model Award {
  id        String    @id @default(cuid())
  petId     String
  title     String
  event     String?
  date      DateTime?
  rank      String?
  examType  String?
  examScore Int?
  courseId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  course    Course?   @relation(fields: [courseId], references: [id])
  pet       Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([courseId])
}

model TrainingAccess {
  trainingId String
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now())
  training   Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingId, userId])
}

model CourseAccess {
  courseId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
}

model Payment {
  id                String            @id @default(cuid())
  userId            String
  courseId          String
  amountRub         Decimal           @db.Decimal(10, 2)
  currency          String            @default("RUB")
  yookassaPaymentId String?           @unique
  confirmationUrl   String?
  status            PaymentStatus     @default(PENDING)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  course            Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  ofertaAcceptances OfertaAcceptance[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model OfertaAcceptance {
  id               String    @id @default(cuid())
  userId           String
  courseId         String
  paymentId        String?
  acceptedAt       DateTime  @default(now())
  ipAddress        String?
  userAgent        String?
  documentVersions Json
  source           String    @db.VarChar(10)

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([courseId])
  @@index([paymentId])
  @@index([acceptedAt])
}

model FavoriteCourse {
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, courseId])
}

model CourseReview {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Float?
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId, userId], map: "idx_rating_course_user")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  shortCode String?  @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PhoneChangeToken {
  id        String   @id @default(cuid())
  userId    String
  shortCode String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  deviceId  String?
  userAgent String?
  ipAddress String?
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  keys      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StepNotification {
  id           String   @id @default(uuid())
  userId       String
  day          Int
  stepIndex    Int
  endTs        Int
  sent         Boolean  @default(false)
  subscription Json
  url          String?
  jobId        String?
  paused       Boolean  @default(false)
  remainingSec Int?
  stepTitle    String?
  type         String   @default("step")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([day, stepIndex])
  @@index([type])
}

model ExamResult {
  id                String    @id @default(cuid())
  userStepId        String    @unique
  stepId            String
  testAnswers       Json?
  testScore         Int?
  testMaxScore      Int?
  videoReportUrl    String?
  videoDeletedAt    DateTime?
  videoDeleteReason String?
  writtenFeedback   String?
  overallScore      Int?
  isPassed          Boolean?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  trainerComment    String?
  reviewedAt        DateTime?
  reviewedById      String?
  reviewedBy        User?     @relation("ExamResultReviewedBy", fields: [reviewedById], references: [id])
  step              Step      @relation(fields: [stepId], references: [id], onDelete: Cascade)
  userStep          UserStep  @relation(fields: [userStepId], references: [id], onDelete: Cascade)

  @@index([userStepId])
  @@index([stepId])
  @@index([videoDeletedAt])
  @@index([reviewedById])
  @@index([reviewedAt])
}

model ReengagementCampaign {
  id                     String                     @id @default(cuid())
  userId                 String
  isActive               Boolean                    @default(true)
  currentLevel           Int                        @default(1)
  lastActivityDate       DateTime
  campaignStartDate      DateTime                   @default(now())
  lastNotificationSent   DateTime?
  nextNotificationDate   DateTime?
  returned               Boolean                    @default(false)
  returnedAt             DateTime?
  unsubscribed           Boolean                    @default(false)
  totalNotificationsSent Int                        @default(0)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  user                   User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications          ReengagementNotification[]

  @@index([userId])
  @@index([isActive, nextNotificationDate])
  @@index([lastActivityDate])
}

model ReengagementNotification {
  id           String               @id @default(cuid())
  campaignId   String
  level        Int
  messageType  String
  variantId    String
  title        String
  body         String
  url          String?
  sent         Boolean              @default(false)
  sentAt       DateTime?
  opened       Boolean              @default(false)
  openedAt     DateTime?
  clicked      Boolean              @default(false)
  clickedAt    DateTime?
  successCount Int                  @default(0)
  failedCount  Int                  @default(0)
  createdAt    DateTime             @default(now())
  campaign     ReengagementCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([sent, sentAt])
}

model ReengagementSettings {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  enabled                 Boolean   @default(true)
  unsubscribedAt          DateTime?
  preferredTime           String?
  timezone                String    @default("Europe/Moscow")
  maxNotificationsPerWeek Int       @default(2)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reminder {
  id           String    @id @default(cuid())
  userId       String
  type         String
  name         String
  enabled      Boolean   @default(false)
  reminderTime String    @default("09:00")
  reminderDays String?
  timezone     String    @default("Europe/Moscow")
  metadata     Json?
  lastSentAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([enabled])
  @@index([type])
  @@index([reminderTime])
}

model ReengagementMetrics {
  id               String   @id @default(cuid())
  date             DateTime @default(now())
  totalActive      Int
  totalSent        Int
  totalReturned    Int
  level1Sent       Int      @default(0)
  level2Sent       Int      @default(0)
  level3Sent       Int      @default(0)
  level4Sent       Int      @default(0)
  openRate         Float?
  clickRate        Float?
  returnRate       Float?
  emotionalSent    Int      @default(0)
  educationalSent  Int      @default(0)
  motivationalSent Int      @default(0)
  mixedSent        Int      @default(0)

  @@index([date])
}

model PresentationView {
  id                String    @id @default(cuid())
  sessionId         String
  visitorId         String?
  referrer          String?
  referrerDomain    String?
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  refParam          String?
  campaignParam     String?
  sourceParam       String?
  tagParam          String?
  userAgent         String?
  ipAddress         String?
  language          String?
  deviceType        String?
  screenWidth       Int?
  screenHeight      Int?
  timeOnPage        Int?
  scrollDepth       Int?
  reachedHero       Int?
  reachedProblem    Int?
  reachedSolution   Int?
  reachedFeatures   Int?
  reachedComparison Int?
  reachedGoals      Int?
  reachedContact    Int?
  ctaClicks         Int       @default(0)
  convertedToUser   Boolean   @default(false)
  convertedUserId   String?
  firstViewAt       DateTime  @default(now())
  lastViewAt        DateTime  @default(now())
  sessionEndedAt    DateTime?
  additionalData    Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([sessionId])
  @@index([visitorId])
  @@index([referrerDomain])
  @@index([refParam])
  @@index([campaignParam])
  @@index([firstViewAt])
  @@index([createdAt])
  @@index([convertedToUser])
  @@index([convertedUserId])
}

model PresentationEvent {
  id            String   @id @default(cuid())
  sessionId     String
  viewId        String?
  eventType     String
  eventName     String
  targetElement String?
  targetSection String?
  scrollDepth   Int?
  timeOnPage    Int?
  metadata      Json?
  createdAt     DateTime @default(now())

  @@index([sessionId])
  @@index([eventType])
  @@index([viewId])
  @@index([createdAt])
}

model ErrorLog {
  id                String    @id @default(cuid())
  message           String
  stack             String?
  level             String    @default("error")
  appName           String
  environment       String    @default("development")
  context           String?
  url               String?
  userAgent         String?
  userId            String?
  sessionId         String?
  componentStack    String?
  additionalContext Json?
  tags              String[]  @default([])
  status            String    @default("new")
  timestamp         DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  resolvedAt        DateTime?
  resolvedBy        String?

  @@index([appName, level, timestamp(sort: Desc)])
  @@index([environment, timestamp(sort: Desc)])
  @@index([status, timestamp(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

model TrainerAIChat {
  id          String   @id @default(cuid())
  trainerId   String
  role        String
  content     String
  tokensUsed  Int?
  createdAt   DateTime @default(now())
  model       String?
  attachments Json?
  trainer     User     @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId, createdAt(sort: Desc)])
  @@index([trainerId])
}

model TrainerAIConfig {
  id        String   @id @default(cuid())
  trainerId String   @unique
  apiKey    String?  @db.VarChar(500)
  model     String   @default("deepseek-chat")
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  provider  String   @default("openrouter")
  trainer   User     @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId])
}

model TrainerNote {
  id        String               @id @default(cuid())
  trainerId String
  createdAt DateTime             @default(now())
  title     String?              @db.VarChar(200)
  tags      String[]             @default([])
  trainer   User                 @relation("TrainerNotes", fields: [trainerId], references: [id], onDelete: Cascade)
  entries   TrainerNoteEntry[]
  students  TrainerNoteStudent[]

  @@index([trainerId, createdAt(sort: Desc)])
}

model TrainerNoteEntry {
  id                 String      @id @default(cuid())
  noteId             String
  content            String
  order              Int         @default(0)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  isVisibleToStudent Boolean     @default(false)
  note               TrainerNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId, order])
}

model TrainerNoteStudent {
  id        String      @id @default(cuid())
  noteId    String
  studentId String
  createdAt DateTime    @default(now())
  note      TrainerNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  student   User        @relation("StudentNotes", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([noteId, studentId])
  @@index([noteId])
  @@index([studentId])
  @@index([studentId, createdAt(sort: Desc)])
}

model ErrorReport {
  id                String    @id
  message           String
  stack             String?
  appName           String
  environment       String
  url               String
  userAgent         String
  userId            String?
  sessionId         String?
  componentStack    String?
  additionalContext Json?
  tags              String[]  @default([])
  resolved          Boolean   @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime

  @@index([appName])
  @@index([createdAt])
  @@index([environment])
  @@index([resolved])
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  RESET
}

enum UserRole {
  USER
  TRAINER
  ADMIN
  MODERATOR
  PREMIUM
}

enum PetType {
  DOG
  CAT
}

enum TrainingLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum StepType {
  TRAINING
  EXAMINATION
  THEORY
  BREAK
  PRACTICE
  DIARY
}

enum TranscodingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  CANCELED
  REFUNDED
}
