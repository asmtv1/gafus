import bcrypt from "bcrypt";

import { prisma } from "./src/index";

const prismaClient = prisma;

async function main() {
  const startTime = Date.now();
  
  console.log("Начинаем сидирование базы данных", {
    environment: process.env.NODE_ENV || 'development',
    databaseUrl: process.env.DATABASE_URL ? 'configured' : 'missing'
  });

  const hashedPassword = await bcrypt.hash("2407041", 10);

  const admin = await prismaClient.user.upsert({
    where: { phone: "+79198031371" },
    update: {},
    create: {
      username: "admin",
      phone: "+79198031371",
      password: hashedPassword,
      role: "ADMIN",
      isConfirmed: true,
    },
  });
  console.log("Админ создан или найден", {
    username: admin.username,
    phone: admin.phone,
    role: admin.role,
    isConfirmed: admin.isConfirmed
  });

  const [homeCourse, streetCourse, puppyCourse, authorCourse] = await prismaClient.$transaction([
    prismaClient.course.upsert({
      where: { type: "home" },
      update: {},
      create: {
        name: "Тренировки дома",
        type: "home",
        description: "Как тренировать хвостика дома",
        shortDesc: "Кратко о курсе",
        duration: "2 недели",
        logoImg: "/uploads/courses/3122311.jpg",
        equipment: "Поводок, игрушки, лакомства",
        trainingLevel: "BEGINNER",
        authorId: admin.id,
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40", // Смешные моменты с собаками
      },
    }),
    prismaClient.course.upsert({
      where: { type: "street" },
      update: {},
      create: {
        name: "Тренировки на улице",
        type: "street",
        description: "Как тренировать хвостика на улице",
        shortDesc: "Кратко о курсе",
        duration: "2 недели",
        logoImg: "/uploads/course-logo.webp",
        equipment: "Поводок, ошейник, лакомства",
        trainingLevel: "INTERMEDIATE",
        authorId: admin.id,
        isPaid: true,
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40", // Смешные собаки на улице
      },
    }),
    prismaClient.course.upsert({
      where: { type: "puppy" },
      update: {},
      create: {
        name: "Щенок на карантине",
        type: "puppy",
        description: "Что делать, пока он маленький",
        shortDesc: "Кратко о курсе",
        duration: "1 месяц",
        logoImg: "/uploads/courses/21312123.jpeg",
        equipment: "Игрушки, лакомства, пеленки",
        trainingLevel: "BEGINNER",
        authorId: admin.id,
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40", // Смешные щенки
      },
    }),
    prismaClient.course.upsert({
      where: { type: "authors" },
      update: {},
      create: {
        name: "Авторский курс",
        type: "authors",
        description: "Супер-методика by Буй с Бугра",
        shortDesc: "Кратко о курсе",
        duration: "много лет",
        logoImg: "/uploads/courses/92086288.jpg",
        equipment: "Специальное оборудование",
        trainingLevel: "EXPERT",
        authorId: admin.id,
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40", // Профессиональная дрессировка
      },
    }),
  ]);
  console.log("Курсы созданы", {
    courseCount: 4,
    courseTypes: ["home", "street", "puppy", "author"]
  });

  const [stepA, stepB, stepC] = await prismaClient.$transaction([
    prismaClient.step.create({
      data: {
        title: "Базовые команды",
        description: `## Основы дрессировки

**Цель:** Обучить собаку базовым командам

### Что изучаем:
- Команда "Сидеть"
- Команда "Лежать" 
- Команда "Стоять"

### Методика:
1. Используйте лакомства как поощрение
2. Повторяйте команды 10-15 раз за сессию
3. Постепенно увеличивайте время выполнения команды

### Оборудование:
- Лакомства
- Поводок`,
        durationSec: 60,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
      },
    }),
    prismaClient.step.create({
      data: {
        title: "Работа с поводком",
        description: `## Правильное использование поводка

**Цель:** Научить собаку ходить рядом без натяжения

### Техника:
- Поводок должен быть свободным
- Собака идет слева от хозяина
- При натяжении - останавливаемся

### Упражнения:
1. Ходьба по прямой
2. Повороты
3. Остановки

### Оборудование:
- Поводок длиной 1.5-2 метра
- Ошейник или шлейка`,
        durationSec: 90,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
      },
    }),
    prismaClient.step.create({
      data: {
        title: "Социализация",
        description: `## Социализация собаки

**Цель:** Приучить собаку к различным ситуациям

### Что включает:
- Встречи с другими собаками
- Контакт с людьми
- Адаптация к шуму

### Этапы:
1. Начинаем с тихих мест
2. Постепенно увеличиваем нагрузку
3. Контролируем реакцию собаки

### Оборудование:
- Поводок
- Лакомства для поощрения
- Игрушки для отвлечения`,
        durationSec: 120,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
      },
    }),
  ]);
  console.log("Базовые шаги созданы", {
    stepCount: 3,
    stepTitles: ["Базовые команды", "Работа с поводком", "Социализация"]
  });

  const baseDay = await prismaClient.trainingDay.create({
    data: {
      title: "Основы дрессировки",
      type: "base",
      equipment: "Поводок длиной 1.5-2 метра, ошейник или шлейка, лакомства, игрушки для отвлечения",
      description: `## День 1: Основы дрессировки

**Цель дня:** Заложить фундамент для дальнейшего обучения собаки

### Что изучаем:
- Базовые команды управления
- Правильную работу с поводком
- Основы социализации

### Структура дня:
1. **Базовые команды** (60 сек) - изучение основных команд
2. **Работа с поводком** (90 сек) - обучение правильной ходьбе
3. **Социализация** (120 сек) - адаптация к различным ситуациям

### Рекомендации:
- Начинайте с коротких сессий
- Используйте позитивное подкрепление
- Будьте терпеливы и последовательны

### Ожидаемый результат:
Собака должна понимать базовые команды и спокойно реагировать на поводок.

`,
      authorId: admin.id,
    },
  });
  await prismaClient.stepOnDay.createMany({
    data: [
      { dayId: baseDay.id, stepId: stepA.id, order: 1 },
      { dayId: baseDay.id, stepId: stepB.id, order: 2 },
      { dayId: baseDay.id, stepId: stepC.id, order: 3 },
    ],
  });
  console.log("Связка шагов с базовым днём выполнена", {
    dayId: baseDay.id,
    stepCount: 3
  });

  for (let i = 1; i <= 14; i++) {
    await prismaClient.dayOnCourse.createMany({
      data: [
        { courseId: homeCourse.id, dayId: baseDay.id, order: i },
        { courseId: streetCourse.id, dayId: baseDay.id, order: i },
      ],
    });
  }
  console.log("Базовый день добавлен в курсы на 14 дней", {
    dayId: baseDay.id,
    courseCount: 4,
    durationDays: 14
  });

  const puppyDay = await prismaClient.trainingDay.create({
    data: {
      title: "Адаптация щенка",
      type: "puppy",
      equipment: "Мягкие игрушки, специальные лакомства для щенков, пеленки, миски для воды и еды",
      description: `## День 1: Адаптация щенка

**Цель дня:** Помочь щенку адаптироваться к новому дому и начать обучение

### Что изучаем:
- Развивающие игры для щенка
- Подготовку к первым прогулкам
- Основы социализации в раннем возрасте

### Структура дня:
1. **Игровая активность** (30 сек) - развивающие игры
2. **Первые прогулки** (30 сек) - подготовка к выходу на улицу

### Особенности работы со щенками:
- Короткие сессии (не более 10-15 минут)
- Много поощрений и игр
- Безопасная среда обучения
- Учет возраста и физических возможностей

### Важные моменты:
- Убедитесь в завершении вакцинации перед прогулками
- Используйте только безопасные игрушки
- Следите за усталостью щенка

### Ожидаемый результат:
Щенок должен быть заинтересован в играх и готов к первым прогулкам.

`,
      authorId: admin.id,
    },
  });
  const [stepP1, stepP2] = await prismaClient.$transaction([
    prismaClient.step.create({
      data: {
        title: "Игровая активность",
        description: `## Развивающие игры для щенка

**Цель:** Развитие координации и социализации

### Рекомендуемые игры:
- Перетягивание мягкой игрушки
- Поиск лакомств
- Игры с мячиком

### Правила:
1. Играйте не более 10-15 минут подряд
2. Следите за усталостью щенка
3. Используйте только безопасные игрушки

### Оборудование:
- Мягкие игрушки без мелких деталей
- Лакомства для щенков

`,
        durationSec: 30,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
      },
    }),
    prismaClient.step.create({
      data: {
        title: "Первые прогулки",
        description: `## Подготовка к прогулкам

**Цель:** Безопасное знакомство с внешним миром

### Подготовка:
- Убедитесь в завершении вакцинации
- Выберите тихое место для первых прогулок
- Начните с коротких выходов (5-10 минут)

### Что изучаем:
- Реакцию на новые звуки
- Поведение при встрече с людьми
- Привыкание к поводку

### Оборудование:
- Легкий поводок
- Ошейник подходящего размера
- Лакомства для поощрения

`,
        durationSec: 30,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
      },
    }),
  ]);
  await prismaClient.stepOnDay.createMany({
    data: [
      { dayId: puppyDay.id, stepId: stepP1.id, order: 1 },
      { dayId: puppyDay.id, stepId: stepP2.id, order: 2 },
    ],
  });
  await prismaClient.dayOnCourse.create({
    data: { courseId: puppyCourse.id, dayId: puppyDay.id, order: 1 },
  });
  console.log("Щенячий день добавлен в курс", {
    dayId: puppyDay.id,
    courseType: "puppy",
    stepCount: 2
  });

  const authorDay = await prismaClient.trainingDay.create({
    data: {
      title: "Продвинутая дрессировка",
      type: "authors",
      equipment: "Кликер, мишени для обучения, препятствия для аджилити, профессиональные лакомства",
      description: `## День 1: Продвинутая дрессировка

**Цель дня:** Освоение профессиональных методов дрессировки по методике "Буй с Бугра"

### Что изучаем:
- Методику позитивного подкрепления
- Использование кликера для точного тайминга
- Поэтапное формирование сложных навыков

### Структура дня:
1. **Методика позитивного подкрепления** (120 сек) - профессиональные техники

### Особенности авторской методики:
- Точный тайминг с помощью кликера
- Поэтапное формирование поведения
- Работа с мотивацией собаки
- Развитие концентрации и интеллекта

### Этапы обучения:
1. **Маркировка поведения** - кликер в момент правильного действия
2. **Подкрепление** - лакомство после кликера
3. **Формирование** - постепенное усложнение задачи

### Практические упражнения:
- Обучение трюкам
- Работа с препятствиями
- Развитие концентрации

### Ожидаемый результат:
Собака должна понимать принципы кликер-дрессировки и быть готова к изучению сложных навыков.

`,
      authorId: admin.id,
    },
  });
  const authorStep = await prismaClient.step.create({
    data: {
      title: "Методика позитивного подкрепления",
      description: `## Продвинутые техники дрессировки

**Цель:** Освоение профессиональных методов обучения

### Методика "Буй с Бугра":
- Использование кликера для точного тайминга
- Поэтапное формирование сложных навыков
- Работа с мотивацией собаки

### Этапы обучения:
1. **Маркировка поведения** - кликер в момент правильного действия
2. **Подкрепление** - лакомство после кликера
3. **Формирование** - постепенное усложнение задачи

### Практические упражнения:
- Обучение трюкам
- Работа с препятствиями
- Развитие концентрации

### Оборудование:
- Кликер для дрессировки
- Разнообразные лакомства
- Мишени и препятствия

`,
        durationSec: 120,
        type: "EXAMINATION",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: admin.id,
    },
  });
  await prismaClient.stepOnDay.create({
    data: { dayId: authorDay.id, stepId: authorStep.id, order: 1 },
  });
  await prismaClient.dayOnCourse.create({
    data: { courseId: authorCourse.id, dayId: authorDay.id, order: 1 },
  });
  console.log("Авторский день добавлен в курс", {
    dayId: authorDay.id,
    courseType: "author",
    stepCount: 1
  });

  await prismaClient.favoriteCourse.createMany({
    data: [
      { userId: admin.id, courseId: homeCourse.id },
      { userId: admin.id, courseId: streetCourse.id },
    ],
    skipDuplicates: true,
  });
  console.log("Курсы добавлены в избранное", {
    userId: admin.id,
    favoriteCount: 4,
    courseTypes: ["home", "street", "puppy", "author"]
  });

  await prismaClient.courseReview.createMany({
    data: [
      {
        userId: admin.id,
        courseId: homeCourse.id,
        rating: 5,
        comment: "Отличный курс, все понравилось!",
      },
      {
        userId: admin.id,
        courseId: streetCourse.id,
        rating: 4,
        comment: "Хороший курс, но хотелось бы больше примеров.",
      },
    ],
    skipDuplicates: true,
  });
  console.log("Отзывы добавлены", {
    reviewCount: 2,
    averageRating: 4.5
  });

  const allCourses = await prismaClient.course.findMany({
    include: { reviews: true },
  });

  for (const course of allCourses) {
    const ratings = course.reviews
      .map((r: { rating: number | null }) => r.rating)
      .filter((r): r is number => typeof r === "number");

    const avg = ratings.length ? ratings.reduce((acc, r) => acc + r, 0) / ratings.length : null;

    await prismaClient.course.update({
      where: { id: course.id },
      data: { avgRating: avg },
    });
  }
  console.log("Средние рейтинги обновлены", {
    courseCount: allCourses.length,
    averageRatings: allCourses.map(c => ({ id: c.id, rating: c.avgRating }))
  });
  const hashedTrainerPassword = await bcrypt.hash("trainer123", 10);

  const trainer = await prismaClient.user.upsert({
    where: { phone: "+79998887766" },
    update: {},
    create: {
      username: "trainer",
      phone: "+79998887766",
      password: hashedTrainerPassword,
      role: "TRAINER",
      isConfirmed: true,
    },
  });
  console.log("Тренер создан", {
    trainerId: trainer.id,
    username: trainer.username,
    phone: trainer.phone,
    role: trainer.role
  });

  const [trainerStep1, trainerStep2] = await prismaClient.$transaction([
    prismaClient.step.create({
      data: {
        title: "Подготовительная разминка",
        description: `## Разминка перед тренировкой

**Цель:** Подготовить собаку к активной работе

### Упражнения разминки:
- Легкая пробежка на поводке
- Растяжка и разогрев мышц
- Психологическая подготовка

### Длительность:
- 5-10 минут для молодых собак
- 10-15 минут для взрослых собак

### Оборудование:
- Поводок
- Лакомства для мотивации

`,
        durationSec: 45,
        type: "TRAINING",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: trainer.id,
      },
    }),
    prismaClient.step.create({
      data: {
        title: "Обучение аппортировке",
        description: `## Развитие навыка аппортировки

**Цель:** Научить собаку приносить и отдавать предметы

### Этапы обучения:
1. **Заинтересованность** - игра с предметом
2. **Преследование** - собака идет за брошенным предметом
3. **Возврат** - принесение предмета хозяину
4. **Отдача** - отпускание предмета по команде

### Методика:
- Начинайте с любимых игрушек собаки
- Используйте лакомства как поощрение
- Постепенно увеличивайте расстояние

### Оборудование:
- Мягкие игрушки для аппортировки
- Лакомства
- Поводок для контроля

`,
        durationSec: 90,
        type: "EXAMINATION",
        videoUrl: "https://www.youtube.com/watch?v=4GdobPQTB40",
        authorId: trainer.id,
      },
    }),
  ]);
  console.log("Шаги тренера созданы", {
    trainerId: trainer.id,
    stepCount: 2,
    stepTitles: ["Подготовительная разминка", "Обучение аппортировке"]
  });

  const [trainerDay1, trainerDay2] = await prismaClient.$transaction([
    prismaClient.trainingDay.create({
      data: {
        title: "Базовая физическая подготовка",
        type: "trainer",
        equipment: "Поводок, лакомства, игрушки для аппортировки, конусы для упражнений",
        description: `## День 1: Базовая физическая подготовка

**Цель дня:** Развить физические способности собаки и подготовить к активным тренировкам

### Что изучаем:
- Подготовительную разминку
- Обучение аппортировке
- Развитие координации и выносливости

### Структура дня:
1. **Подготовительная разминка** (45 сек) - разогрев перед тренировкой
2. **Обучение аппортировке** (90 сек) - развитие навыка принесения предметов

### Особенности физической подготовки:
- Постепенное увеличение нагрузки
- Контроль за состоянием собаки
- Разнообразие упражнений
- Правильная техника выполнения

### Рекомендации:
- Начинайте с легких упражнений
- Следите за дыханием собаки
- Делайте перерывы при необходимости
- Используйте поощрения для мотивации

### Ожидаемый результат:
Собака должна быть физически активной и готовой к более сложным упражнениям.

`,
        authorId: trainer.id,
      },
    }),
    prismaClient.trainingDay.create({
      data: {
        title: "Развитие интеллектуальных навыков",
        type: "trainer",
        equipment: "Пазлы для собак, интерактивные игрушки, кликер, разнообразные лакомства",
        description: `## День 2: Развитие интеллектуальных навыков

**Цель дня:** Стимулировать умственное развитие собаки и развить концентрацию

### Что изучаем:
- Работу с интерактивными игрушками
- Решение простых задач
- Развитие концентрации и памяти

### Структура дня:
1. **Обучение аппортировке** (90 сек) - развитие интеллектуальных навыков
2. **Подготовительная разминка** (45 сек) - умственная разминка

### Особенности интеллектуального развития:
- Постепенное усложнение задач
- Использование различных типов игрушек
- Развитие логического мышления
- Стимулирование любознательности

### Методы обучения:
- Пазлы для собак
- Интерактивные игрушки
- Игры на поиск
- Обучение трюкам

### Рекомендации:
- Начинайте с простых задач
- Поощряйте попытки решения
- Не перегружайте собаку
- Делайте занятия интересными

### Ожидаемый результат:
Собака должна проявлять интерес к решению задач и быть более сосредоточенной.

`,
        authorId: trainer.id,
      },
    }),
  ]);

  await prismaClient.stepOnDay.createMany({
    data: [
      { dayId: trainerDay1.id, stepId: trainerStep1.id, order: 1 },
      { dayId: trainerDay1.id, stepId: trainerStep2.id, order: 2 },
      { dayId: trainerDay2.id, stepId: trainerStep2.id, order: 1 },
      { dayId: trainerDay2.id, stepId: trainerStep1.id, order: 2 },
    ],
  });
  console.log("Дни тренера со связанными шагами созданы", {
    trainerId: trainer.id,
    dayCount: 2,
    totalSteps: 4
  });

  const [trainerCourse1, trainerCourse2] = await prismaClient.$transaction([
    prismaClient.course.create({
      data: {
        name: "Курс тренера 1",
        type: "trainer-course-1",
        description: "Первый курс от тренера",
        shortDesc: "Кратко о первом курсе",
        duration: "3 дня",
        logoImg: "/uploads/courses/trainer1.jpg",
        equipment: "Базовое оборудование для тренировок",
        trainingLevel: "INTERMEDIATE",
        authorId: trainer.id,
      },
    }),
    prismaClient.course.create({
      data: {
        name: "Курс тренера 2",
        type: "trainer-course-2",
        description: "Второй курс от тренера",
        shortDesc: "Кратко о втором курсе",
        duration: "5 дней",
        logoImg: "/uploads/courses/trainer2.jpg",
        equipment: "Продвинутое оборудование",
        trainingLevel: "ADVANCED",
        authorId: trainer.id,
      },
    }),
  ]);

  // Добавляем тренерские дни в оба курса
  await prismaClient.dayOnCourse.createMany({
    data: [
      { courseId: trainerCourse1.id, dayId: trainerDay1.id, order: 1 },
      { courseId: trainerCourse1.id, dayId: trainerDay2.id, order: 2 },
      { courseId: trainerCourse2.id, dayId: trainerDay2.id, order: 1 },
      { courseId: trainerCourse2.id, dayId: trainerDay1.id, order: 2 },
    ],
  });

  console.log("Курсы тренера созданы и дни добавлены в них", {
    trainerId: trainer.id,
    courseCount: 2,
    totalDays: 4
  });

  // Создаем категории для шаблонов шагов
  const [movementCategory, staticsCategory, recallCategory, refusalCategory, stateControlCategory] = await prismaClient.$transaction([
    prismaClient.stepCategory.create({
      data: {
        name: "Движение",
        description: `- движение на провисшем поводке;
- движение рядом у левой и у правой ноги;
- движение без поводка в заданном радиусе;`,
        icon: "🚶",
        order: 1,
      },
    }),
    prismaClient.stepCategory.create({
      data: {
        name: "Статика",
        description: `- Смена позиций лежать, стоять, сидеть по голосовой команде и жесту;
- выдержка в статике при раздражителях в отсутствии проводника;
- высыл по команде на место и сохранения положения столько, сколько необходимо;`,
        icon: "⏸️",
        order: 2,
      },
    }),
    prismaClient.stepCategory.create({
      data: {
        name: "Подзыв",
        description: `- подзыв по рабочей кличке;
- подзыв по команде «ко мне»;
- отзыв от еды, игр с другими собаками и людей;`,
        icon: "📢",
        order: 3,
      },
    }),
    prismaClient.stepCategory.create({
      data: {
        name: "Неподбор",
        description: `- запрещающая команда;
- отказ от лакомства от посторонних людей;
- неподбор по умолчанию;`,
        icon: "🚫",
        order: 4,
      },
    }),
    prismaClient.stepCategory.create({
      data: {
        name: "Контроль состояния",
        description: `- импульс контроль;
- умение расслабляться в новых локациях;
- быстрый переход от возбуждения в спокойное состояние: игра, встреча гостей и т.д.;`,
        icon: "🧘",
        order: 5,
      },
    }),
  ]);
  console.log("Категории шаблонов созданы", {
    categoryCount: 5,
    categories: ["Движение", "Статика", "Подзыв", "Неподбор", "Контроль состояния"]
  });

  // Создаем шаблоны шагов из JSON
  await prismaClient.$transaction([
    // Подзыв и отзыв
    prismaClient.stepTemplate.create({
      data: {
        title: "Подзыв — базовый (рабочая кличка + «ко мне»)",
        description: `## Цель
Научить собаку быстро и корректно подходить по рабочей кличке и команде «ко мне», занимая фронтальную позицию (ОП).

## Оборудование
- Короткий поводок (1.5–2 м)
- Лакомства маленького размера
- Маркер (звук/слово) или кликер

## Методика — пошагово
1. Начинаем в тихой комнате: зовём по рабочей кличке, показываем лакомство в руке, отзываем командой «ко мне».  
2. Как только собака пришла — маркируем (клик/«да»), даём лакомство, затем просим занять ОП (короткая команда или наведение).  
3. Повтор 6–10 раз, затем делаем паузу и даём 1–2 контролируемых «проверочных» повтора без лакомства в руках (подкрепление после занятия позиции).

## Прогрессия
- Переводим на более длинную дистанцию; затем в поле с лёгкими отвлечениями.

## Частые ошибки и исправления
- Собака не подходит быстро → уменьшить дистанцию, увеличить интенсивность подкрепления, добавить удержание перед выпуском.
- Подход, но не ОП → тренировка перехода в ОП отдельно (см. «Повороты на месте в ОП»).

## Контрольная задача
Отзыв с 5–10 м с 80% успешностью и корректной ОП в 3 из 4 попыток.`,
        durationSec: 30,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["подзыв", "базовый", "рабочая кличка", "ОП"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Подзыв — с удержанием/стимуляцией",
        description: `## Цель
Усилить мотивацию на подзыв, сформировать стремительный и уверенный подход.

## Оборудование
- Ассистент/помощник
- Поводок
- Лакомства/игрушка

## Методика
1. Ассистент держит собаку (мягко на поводке или рукой) на небольшом расстоянии. Проводник отходит, создаёт интерес, затем даёт команду «ко мне».  
2. В момент подхода ассистент отпускает, собака бежит к проводнику — маркируем и даём мощное подкрепление.  
3. Повторять 4–6 подходов, постепенно уменьшать помощь ассистента.

## Вариант прогрессии
- Заменить удержание на легкое отвлечение: ассистент разбрасывает игрушки — собака должна вернуться на команду.

## Подсказки
- Удержание должно быть безопасным и спокойным — не дёргать.
- Сильное подкрепление (эмоция, голос, лакомство) формирует мотивацию.`,
        durationSec: 40,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["подзыв", "удержание", "мотивация"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Подзыв — через провокации (игрушки/лакомства/ассистент)",
        description: `## Цель
Научить отзыву в присутствии сильных отвлекающих стимулов.

## Оборудование
- Несколько игрушек/разбросанные лакомства
- Ассистент
- Длинный поводок (для страховки)

## Методика
1. Поместите провокации на поле (игрушки/кусочки еды). Пусть собака заинтересуется.  
2. В нужный момент даём команду «ко мне». При подходе — маркируем и подкрепляем. Если собака идёт к провокации — переключаем внимание с помощью яркой демонстрации лакомства/голоса и повторяем.

## Прогрессии
- Увеличивать количество и силу провокаций.
- Переносить на улицу/парк.

## Советы по безопасности
- Всегда используйте страховочный поводок пока провокация сильная.
- Не наказывайте за ошибку — корректируйте мягко и верните успехом.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["подзыв", "провокации", "отвлечения"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Подзыв — от собак (из игры с другими собаками)",
        description: `## Цель
Отзыв собаки, когда она вовлечена в социальную игру с другими собаками.

## Оборудование
- Поле/парк
- Ассистент с питомцем (отвлекающий)
- Длинный поводок для подстраховки

## Методика
1. Дайте собакам поиграть короткий период, затем используйте сильный, позитивный стимул для отзыва (игрушка, лакомство, громкий радостный голос).  
2. Как только собака реагирует — маркируем и подкрепляем крупным поощрением. Если собака не отзывается — уменьшите интенсивность игры и отработайте отзыв в более спокойной ситуации.

## Прогрессия
- Увеличивать длительность игры перед отзывом.

## Ошибки
- Игнорирование → вернуться к базовой работе с удержанием и подзывом с асистентом.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["подзыв", "собаки", "социализация"],
        authorId: admin.id,
      },
    }),
    // Этапы отзыва
    prismaClient.stepTemplate.create({
      data: {
        title: "Отзыв — этап 30% (короткая дистанция)",
        description: `## Цель
Пошаговое увеличение дистанции отзыва; первый уровень — короткая дистанция (~30% от целевой).

## План тренировки
- Разбить дистанцию на этапы; в этом упражнении — первый этап. Отзыв с лёгким отвлечением, на поводке.

## Рекомендации
- 6–8 повторов, фокус на скорости и точности входа в ОП.
- Если собака теряет скорость — уменьшить дистанцию и увеличить мотивацию.`,
        durationSec: 30,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["отзыв", "прогрессия", "30%"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Отзыв — этап 50% (средняя дистанция)",
        description: `## Цель
Увеличить дистанцию отзыва до среднего уровня, ввести умеренные отвлечения.

## Метод
- Отзыв с дистанции, эквивалентной ~50% целевой. Страховочный поводок при необходимости. Фокус — удержать скорость и корректность ОП.

## Прогрессия
- Добавлять провокации и перемещать занятие в более «шумные» места.`,
        durationSec: 35,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["отзыв", "прогрессия", "50%"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Отзыв — этап 70% (удлинённая дистанция)",
        description: `## Цель
Отработка отзыва с дальней дистанции (≈70%), усиление требований к дисциплине при провокациях.

## Указания
- Проводник использует сильный маркер и премию, ассистент может создавать отвлечение на конце дистанции. При ошибке — аккуратно вернуть и повторить на более короткой дистанции.

## Контроль
- 4–6 повторов, фиксировать время до подзыва.`,
        durationSec: 40,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["отзыв", "прогрессия", "70%"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Отзыв — этап 100% (полный отзыв, контрольная задача)",
        description: `## Цель
Проверочная задача: полный отзыв на целевой дистанции (10–15 м или больше) со сложными провокациями.

## Сценарий контрольной задачи
1. Разместите ассистента, который будет зазывать и показывать игрушку.  
2. Проводник подаёт команду «ко мне». Оцениваем: время приближения, корректность ОП, степень отвлечения.

## Критерии успешности
- Скорость: в пределах нормы для данной породы/возраста.
- ОП: собака в фронтале без рывков и с контролем.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["отзыв", "экзамен", "100%", "контроль"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Отзыв в городе — контрольная задача с ассистентом и провокациями",
        description: `## Цель
Проверить надежность отзыва в городской среде с реальными отвлекающими факторами.

## Сценарий теста
- Ассистент создаёт отвлечение (зазывает, разбрасывает игрушку). Проводник вызывает собаку. Оценка по времени, точности позиции и удержанию внимания.

## Критерии
- Надёжный отзыв при минимальном вмешательстве поводка в 80% случаев.`,
        durationSec: 90,
        type: "TRAINING",
        categoryId: recallCategory.id,
        tags: ["отзыв", "город", "контроль", "провокации"],
        authorId: admin.id,
      },
    }),
    // Работа на поводке
    prismaClient.stepTemplate.create({
      data: {
        title: "Провисший поводок — базовый",
        description: `## Цель
Формирование спокойного движения на провисшем поводке (поводок свободен, нет натяжения).

## Оборудование
- Поводок 1.5–3 м
- Лакомства

## Пошагово
1. Идём медленно, вознаграждаем моменты, когда поводок свободен.  
2. При появлении натяжения — остановка и смена направления (не тянуть), вознаграждение при восстановлении провиса.

## Советы
- Не делайте резких рывков — используйте смену направления как коррекцию.
- Тренируйте в тихом месте и постепенно добавляйте отвлечения.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["поводок", "базовый", "провис"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Провисший поводок — с отвлечениями и коррекцией",
        description: `## Цель
Закрепить поведение провисшего поводка в городских/шумных условиях.

## Метод
- Вводите внешние стимулы (люди, пешеходы, шум), используйте короткие серии: 30–60 с движения, затем награда. При нарушении — корректировка сменой направления + повтор.

## Тонкости
- Оценивайте усталость — длительные интенсивные тренировки снижают внимание.`,
        durationSec: 90,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["поводок", "отвлечения", "город"],
        authorId: admin.id,
      },
    }),
    // Движение у ноги
    prismaClient.stepTemplate.create({
      data: {
        title: "Движение у ноги — базовое (рядом)",
        description: `## Цель
Формирование точного движения рядом с проводником (основная позиция — у левой ноги).

## Оборудование
- Короткий поводок
- Лакомства

## Пошагово
1. Начинаем медленные шаги, отмечаем маркером моменты идеального положения.  
2. Постепенно увеличиваем темп и длину проходки.

## Подсказки
- Тренируйте повороты отдельно.
- Следите за положением головы — не должно быть излишней тяги вперед/назад.`,
        durationSec: 90,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["рядом", "базовый", "у ноги"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Движение у ноги — с поворотами/провокациями",
        description: `## Цель
Сохранение позиции у ноги при манёврах, поворотах и внешних отвлечениях.

## Упражнения
- Серия 90° и 180° поворотов с удержанием позиции.  
- Переходы с медленного шага в быстрый и обратно.

## Тренировочная сессия
- 3 прохода по 60–90 с с акцентом на точность поворотов и минимальные смещения позиции.`,
        durationSec: 90,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["рядом", "повороты", "сложный"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Повороты на месте в ОП (90°/180°)",
        description: `## Цель
Быстрая и корректная смена направления при остановке: сидеть/стоять/повернуться и продолжить движение.

## Метод
1. Из движения дать команду на остановку, затем повернуться направо/налево, занять ОП и продолжить шаг.
2. Награждать за точность и компактность позиции.

## Ошибки
- Собака опаздывает — уменьшить скорость проводника и тренировать на месте.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["повороты", "ОП", "остановка"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Остановка из движения по команде «стой»",
        description: `## Цель
Научить точной и моментальной остановке по команде во время движения.

## Техника
1. Во время движения проводник даёт команду «стой» — собака немедленно прекращает движение и фиксируется.  
2. Оцениваем: моментальная реакция, равномерность позиции, отсутствие рывков.

## Тренировка
- 6–8 повторов с разной скоростью движения и в разных локациях.`,
        durationSec: 45,
        type: "TRAINING",
        categoryId: movementCategory.id,
        tags: ["остановка", "стой", "команда"],
        authorId: admin.id,
      },
    }),
    // Статика и выдержка
    prismaClient.stepTemplate.create({
      data: {
        title: "Статика — высыл на место (коврик) — базовый",
        description: `## Цель
Научить заходу на коврик и выдержке: 2 лапы → 4 лапы → укладка.

## Порядок действий
1. Привлекаем внимание к коврику, направляем на две лапы, затем командой добиваемся 4 лап и укладки.  
2. Маркируем каждый успех, постепенно увеличиваем выдержку до 30–60 с.

## Советы
- Используйте коврик как «мобильное место»: собака должна понимать, что коврик — безопасная и ожидаемая цель.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: staticsCategory.id,
        tags: ["коврик", "место", "базовый"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Коврик — мобильное место: перемещение и поведение в публичных местах",
        description: `## Цель
Генерализация поведения коврика: собака уверенно заходит на коврик в разных локациях и выдерживает отвлечения.

## Сценарий
1. Переносите коврик в разные зоны (улица, кафе, магазин).  
2. Выполняйте заходы и выдержки, постепенно увеличивая длительность и добавляя реальных провокаций.

## Критерии
- Собака занимает коврик в 3 из 4 попыток в новой локации.
- Выдержка 60–120 с с умеренными отвлечениями.`,
        durationSec: 120,
        type: "TRAINING",
        categoryId: staticsCategory.id,
        tags: ["коврик", "публичные места", "генерализация"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Коврик — выдержка с провокациями (кафе/публичные места)",
        description: `## Цель
Укрепить способность оставаться на коврике при сильных отвлекающих факторах.

## Упражнение
- Организуйте имитацию кафе: рядом люди двигаются, кто-то кладёт еду. Проводник уходит на небольшой промежуток (напр. 30 с) и возвращается.

## Оценка
- Уровень устойчивости: не уходить с коврика, не подбирать еду, сохранять спокойствие.

## Меры безопасности
- Важно, чтобы провокации были безопасны и не стимулировали агрессию.`,
        durationSec: 120,
        type: "TRAINING",
        categoryId: staticsCategory.id,
        tags: ["коврик", "выдержка", "кафе", "провокации"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Высы́л вперёд и отзыв на место — длительная выдержка",
        description: `## Цель
Научить высылам на дистанцию с последующей выдержкой до 2–3 минут и отзывом.

## Сценарий
1. Высылаем собаку вперёд на заданную точку, команда на укладку/выдержку.  
2. Проводник отходит на заданную дистанцию, затем вызывает по «ко мне», повторно фиксирует ОП/укладку.

## Техничные моменты
- Увеличивать выдержку постепенно (по 15–30 с на сессию).  
- Вводить реальные провокации только при стабильной выдержке на короткой дистанции.`,
        durationSec: 120,
        type: "TRAINING",
        categoryId: staticsCategory.id,
        tags: ["высыл", "выдержка", "дистанция"],
        authorId: admin.id,
      },
    }),
    // Неподбор
    prismaClient.stepTemplate.create({
      data: {
        title: "Неподбор — открытые боксы",
        description: `## Цель
Обучить собаке обходить видимые лакомства/предметы без подбора.

## Пошагово
1. Разложите открытые боксы с лакомствами на пути движения.  
2. Поощряйте обход без внимания к еде — награда даётся за прохождение мимо.

## Прогрессия
- Увеличивать разнообразие и силу лакомств.
- Вводить в связке с другими заданиями (движение рядом, подзыв).

## Контроль
- 8 из 10 успешных обходов на уровне.`,
        durationSec: 45,
        type: "TRAINING",
        categoryId: refusalCategory.id,
        tags: ["неподбор", "открытые боксы"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Неподбор — закрытые боксы (сложный вариант)",
        description: `## Цель
Проверить устойчивость команды неподбора, когда содержание боксов скрыто.

## Сценарий
1. Поместите лакомства в закрытые ёмкости/ящики, расположенные случайно.  
2. Собака должна пройти мимо, не исследуя каждый бокс.

## Оценка
- Успех при первом обходе без взаимодействия в 7 из 10 попыток.

## Замечания
- Нельзя использовать опасные или вредные предметы; контроль при первых попытках обязателен.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: refusalCategory.id,
        tags: ["неподбор", "закрытые боксы", "сложный"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Неподбор — в связке с другими командами",
        description: `## Цель
Тренировать неподбор как элемент сценариев (подзыв, движение рядом, коврик) для устойчивости навыка.

## Примеры связок
- Движение рядом → прохождение открытых боксов → подзыв и ОП.  
- Высыл на коврик → по дороге мимо боксов → выдержка.

## Рекомендации
- Использовать короткие связки (2–3 упражнения) и повторять 4–6 раз.`,
        durationSec: 60,
        type: "TRAINING",
        categoryId: refusalCategory.id,
        tags: ["неподбор", "связки", "комплекс"],
        authorId: admin.id,
      },
    }),
    // Техники и методы
    prismaClient.stepTemplate.create({
      data: {
        title: "Удержание (техника усиления подзыва)",
        description: `## Цель
Использовать удержание для повышения мотивации к быстрому подзыву.

## Описание
- Ассистент задерживает собаку на короткий момент перед сигналом — затем отпускает одновременно с командой. Это формирует стремительный старт к проводнику.

## Советы
- Удержание должно быть мягким; следите за стрессом у собаки.
- После удержания обязательно сильное поощрение.`,
        durationSec: 30,
        type: "TRAINING",
        categoryId: stateControlCategory.id,
        tags: ["удержание", "техника", "подзыв"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Наведение (рука/мишень/поводок) — формирование траектории",
        description: `## Цель
Формировать корректные траектории движения и точные заходы в позицию с помощью внешних ориентиров.

## Упражнения
- Ведение рукой: собака следует за рукой к нужной точке.  
- Ведение мишенью/поводком: постепенное уменьшение физической помощи.

## Прогрессия
- Снять физическое наведение, оставить сигнальную подсказку.

## Подсказки
- Отрабатывать сначала на коротких отрезках, затем увеличивать дистанцию.`,
        durationSec: 45,
        type: "TRAINING",
        categoryId: stateControlCategory.id,
        tags: ["наведение", "мишень", "техника"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Шейпинг / маркировка предложенного поведения",
        description: `## Цель
Формировать новые или сложные поведенческие элементы через шейпинг и маркировку.

## Метод
1. Отмечайте ближайшие приближения к желаемому поведению (клик/маркер).  
2. Постепенно повышайте требуемый уровень (точность/скорость).  
3. Награда — переменная, для усиления мотивации.

## Примечание
- Шейпинг эффективен для трюков и нетипичных задач; требует терпения и много повторов.`,
        durationSec: 30,
        type: "TRAINING",
        categoryId: stateControlCategory.id,
        tags: ["шейпинг", "маркировка", "поведение"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Контроль состояния — переход возбуждение→спокойствие",
        description: `## Цель
Научить собаку быстро переключаться из возбужденного состояния в спокойное по сигналу проводника.

## Упражнение
- Используйте короткие игры → резкая команда на релакс (например, укладка/коврик) → маркер и награда за спокойствие. Тренировать повторно, увеличивая время до 30+ с спокойствия.

## Подсказки
- Размер и интенсивность подкрепления влияют на скорость переключения.`,
        durationSec: 30,
        type: "TRAINING",
        categoryId: stateControlCategory.id,
        tags: ["контроль", "состояние", "переключение"],
        authorId: admin.id,
      },
    }),
    prismaClient.stepTemplate.create({
      data: {
        title: "Генерализация навыков в городской среде",
        description: `## Цель
Перенос навыков из тренировочной площадки в реальные маршруты и публичные места.

## Практика
- Выполнять короткие сессии у магазинов, на остановках, в парках. Оценивать поведение без поводка (на продвинутых этапах).

## Рекомендации
- Двигаться постепенно, поэтапно увеличивать сложность окружения.
- Делать записи/заметки после каждой сессии для корректировки плана.`,
        durationSec: 90,
        type: "TRAINING",
        categoryId: stateControlCategory.id,
        tags: ["генерализация", "город", "практика"],
        authorId: admin.id,
      },
    }),
  ]);
  console.log("Шаблоны шагов созданы из JSON", {
    templateCount: 27,
    categories: 6,
    categoryNames: ["Подзыв и отзыв", "Работа на поводке", "Движение у ноги", "Статика и выдержка", "Неподбор", "Техники и методы"]
  });

  console.log("Seed успешно выполнен", {
    totalOperations: 19,
    duration: Date.now() - startTime,
    environment: process.env.NODE_ENV || 'development'
  });
}

main()
  .then(() => prismaClient.$disconnect())
  .catch((e) => {
    console.error("Ошибка при сидировании", e as Error, {
      environment: process.env.NODE_ENV || 'development',
      databaseUrl: process.env.DATABASE_URL ? 'configured' : 'missing'
    });
    prismaClient.$disconnect().finally(() => process.exit(1));
  });
