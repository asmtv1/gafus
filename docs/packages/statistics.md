# @gafus/statistics ‚Äî –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–æ–≤

## üìã –û–±–∑–æ—Ä
–ü–∞–∫–µ—Ç `@gafus/statistics` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å—é —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ª–æ–≥–∏–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å–æ —Å–±–æ—Ä–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫—É—Ä—Å–∞–º, —à–∞–≥–∞–º –∏ –∞–≤—Ç–æ—Ä–∞–º. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –∏ –≤ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–Ω–µ—Ä–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤ —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π (`getCourseStatistics`)
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫—É—Ä—Å—É (`getDetailedCourseStatistics`)
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —à–∞–≥–∞–º –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞ (`getStepStatistics`, `getDetailedStepStatistics`)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –∫—É—Ä—Å–∞—Ö —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`getAuthoredCoursesWithStats`)
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫—É—Ä—Å—É (`getUserProgress`)
- –¢–∏–ø—ã `CourseStats`, `DetailedCourseStats`, `StepStats`, `StatisticsData`, `UserDetailedProgress` –¥–ª—è UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
### –ö—É—Ä—Å—ã –≤ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–Ω–µ—Ä–∞
```typescript
import { getCourseStatistics } from "@gafus/statistics";

const data = await getCourseStatistics(userId, isElevated);
return { success: true, data };
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–∞
```typescript
import { getDetailedCourseStatistics } from "@gafus/statistics";

const course = await getDetailedCourseStatistics(courseId, userId, isElevated);
if (!course) notFound();
```

### –ö—É—Ä—Å—ã –∞–≤—Ç–æ—Ä–∞ –≤ web
```typescript
import { getAuthoredCoursesWithStats } from "@gafus/statistics";

export async function getAuthoredCourses(userId: string) {
  return getAuthoredCoursesWithStats(userId);
}
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —à–∞–≥–∞–º
```typescript
import { getStepStatistics, getDetailedStepStatistics } from "@gafus/statistics";

const steps = await getStepStatistics(userId, isElevated);
const detailed = await getDetailedStepStatistics(stepId, userId, isElevated);
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```typescript
import { getUserProgress } from "@gafus/statistics";

const progress = await getUserProgress(courseId, userId);
if (!progress) return null;

progress.days.forEach((day) => {
  day.steps.forEach((step) => {
    // step.status === "COMPLETED" | "IN_PROGRESS" | "NOT_STARTED"
  });
});
```

## üß© –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- `apps/trainer-panel` ‚Äî –≤—Å–µ server actions –∏ React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–∏–ø—ã –∏–∑ –ø–∞–∫–µ—Ç–∞, –≤–∫–ª—é—á–∞—è `getUserProgress` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —à–∞–≥–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (`unstable_cache`, React Query) —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–≤–µ—Ä—Ö –µ–¥–∏–Ω–æ–≥–æ API

## üë• –£—á—ë—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- `getCourseStatistics` –∏ `getDetailedCourseStatistics` –æ–±—ä–µ–¥–∏–Ω—è—é—Ç `course.userCourses` —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ `userTraining`/`userStep`. –ü–æ—ç—Ç–æ–º—É –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —É—á–µ–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∞–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –¥–Ω–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤ `userCourse` –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.
- `getUserProgress` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ –∂–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —à–∞–≥–∞–º–∏ –∏ –¥–Ω—è–º–∏, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ —Å–æ–±–∏—Ä–∞–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.

**–ü–æ—á–µ–º—É –º–æ–∂–µ—Ç –±—ã—Ç—å `userTraining`/`userStep` –±–µ–∑ `userCourse`?**

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–Ω—è**: –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–Ω—è –∫—É—Ä—Å–∞ —Ñ—É–Ω–∫—Ü–∏—è `getTrainingDayWithUserSteps` —Å –æ–ø—Ü–∏–µ–π `createIfMissing: true` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç `userTraining` –∏ –≤—Å–µ `userStep` –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –¥–Ω—è (—ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–µ–Ω `userStepId` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤). –ù–æ `userCourse` —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ —à–∞–≥–∞ —á–µ—Ä–µ–∑ `startUserStepServerAction`.

2. **–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏**: –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —à–∞–≥–∞ —Å–æ–∑–¥–∞–Ω–∏–µ `userCourse` –æ–±—ë—Ä–Ω—É—Ç–æ –≤ try-catch, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ. –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ `userCourse` —É–ø–∞–ª–æ —Å –æ—à–∏–±–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ race condition –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º —Å –ë–î), —Ç–æ `userTraining` –∏ `userStep` —É–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã, –∞ `userCourse` ‚Äî –Ω–µ—Ç.

3. **–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —à–∞–≥–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–µ) —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç `userStep`, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞—é—Ç `userCourse`.

- –°—Ç–∞—Ç—É—Å—ã –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–Ω–µ–π –∫—É—Ä—Å–∞: –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –¥–µ–Ω—å ‚Üí `COMPLETED`, –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –¥–Ω—è ‚Üí `IN_PROGRESS`, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π ‚Üí `NOT_STARTED`.
- –î–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –Ω–∏–∫ –∏ –∞–≤–∞—Ç–∞—Ä –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–Ω–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏ –∏—Ö —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ" `userCourse`.

## üìù –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ: –≤—ã–∑—ã–≤–∞—Ç—å –∏—Ö –Ω—É–∂–Ω–æ –∏–∑ server actions –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü–∞–∫–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `@gafus/prisma`, –ø–æ—ç—Ç–æ–º—É –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ Node-—Å—Ä–µ–¥–µ

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- [ ] –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `package.json` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω `@gafus/statistics`
- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–∏–ø—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–∞–∫–µ—Ç–∞, –∞ –Ω–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –í—ã–∑—ã–≤–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Next.js Server Components/Actions)

