# @gafus/webpush - Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üìã –û–±–∑–æ—Ä

–ü–∞–∫–µ—Ç `@gafus/webpush` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ Web Push API.

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- **–û—Ç–ø—Ä–∞–≤–∫–∞ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** —á–µ—Ä–µ–∑ Web Push API
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫** –∏ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å VAPID** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üì¶ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ v2.5.4)

```typescript
import { sendImmediatePushNotification } from '@gafus/webpush';

// –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
await sendImmediatePushNotification({
  userId: 'user-id',
  title: '"–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã" –∑–∞—á—Ç—ë–Ω! ‚úÖ',
  body: '–¢—Ä–µ–Ω–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏–ª –≤–∞—à —ç–∫–∑–∞–º–µ–Ω. –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.',
  url: '/trainings/authors/1',
  icon: '/icons/icon192.png',
  badge: '/icons/badge-72.png'
});
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (delay: 0)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (3 –ø–æ–ø—ã—Ç–∫–∏)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Discriminated Union (v2.5.4)
- ‚úÖ **–Ø–≤–Ω–æ–µ –ø–æ–ª–µ —Ç–∏–ø–∞** - `type: "immediate"` –≤–º–µ—Å—Ç–æ `stepIndex: -1` (v2.5.4)

### –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```typescript
import { sendPushNotification } from '@gafus/webpush';

await sendPushNotification({
  subscription: pushSubscription,
  payload: {
    title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    body: '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    icon: '/icon.png',
    badge: '/badge.png'
  }
});
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
```typescript
import { subscribeUser, unsubscribeUser } from '@gafus/webpush';

// –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const subscription = await subscribeUser(userId, pushSubscription);

// –û—Ç–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await unsubscribeUser(userId);
```

## üîß API

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- **`sendImmediatePushNotification(options)`** - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (v2.5+)
  - `userId: string` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `title: string` - –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - `body: string` - –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - `url?: string` - URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
  - `icon?: string` - –ò–∫–æ–Ω–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - `badge?: string` - Badge –¥–ª—è iOS
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{ success: boolean; notificationId?: string; error?: string }`

- **`sendPushNotification(options)`** - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **`subscribeUser(userId, subscription)`** - –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **`unsubscribeUser(userId)`** - –û—Ç–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **`validateSubscription(subscription)`** - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

### –ö–ª–∞—Å—Å—ã

- **`PushNotificationService`** - –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **`DeviceSubscriptionManager`** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v2.5.4)

### Discriminated Union –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Discriminated Union** –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```typescript
// –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
type NotificationType = 'step' | 'immediate';

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
interface StepNotificationData {
  type: 'step';
  stepTitle: string;
  stepIndex: number;
  url?: string;
}

interface ImmediateNotificationData {
  type: 'immediate';
  title: string;
  body: string;
  url?: string;
}

// –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–∏–ø
type NotificationData = StepNotificationData | ImmediateNotificationData;
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

- ‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - TypeScript –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø—ã –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚úÖ **–ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç** - IDE –∑–Ω–∞–µ—Ç –∫–∞–∫–∏–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ **–Ø–≤–Ω–æ—Å—Ç—å** - —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—á–µ–≤–∏–¥–µ–Ω –∏–∑ –∫–æ–¥–∞
- ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ magic numbers** - —É–±—Ä–∞–Ω `stepIndex: -1` –∫–∞–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–∞

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ type –≤ StepNotification
ALTER TABLE "StepNotification" ADD COLUMN "type" TEXT NOT NULL DEFAULT 'step';
CREATE INDEX "StepNotification_type_idx" ON "StepNotification"("type");

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
UPDATE "StepNotification" SET "type" = 'immediate' WHERE "stepIndex" = -1;
```
