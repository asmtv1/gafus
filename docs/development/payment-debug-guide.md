# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ç–ª–∞–¥–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa

## –î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `console.log` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã.

### 1. Webhook endpoint (`apps/web/src/app/api/v1/payments/webhook/route.ts`)

–õ–æ–≥–∏—Ä—É–µ—Ç:
- ‚úÖ –í—Ö–æ–¥—è—â–∏–π IP –∞–¥—Ä–µ—Å
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É IP whitelist
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É HMAC –ø–æ–¥–ø–∏—Å–∏
- ‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (type, event, yookassaPaymentId, amount)
- ‚úÖ –ö–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
[payments/webhook] –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç IP: 185.71.76.10
[payments/webhook] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ { hasSignature: true, hasSecretKey: true }
[payments/webhook] –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ {
  type: 'notification',
  event: 'payment.succeeded',
  yookassaPaymentId: '2d72xxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',
  amount: '1000.00'
}
[payments/webhook] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è { event: 'payment.succeeded', yookassaPaymentId: '...' }
[payments/webhook] -> –í—ã–∑–æ–≤ confirmPaymentFromWebhook
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (`packages/core/src/services/payments/paymentService.ts`)

–õ–æ–≥–∏—Ä—É–µ—Ç:
- ‚úÖ –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ yookassaPaymentId
- ‚úÖ –î–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É —Å—É–º–º—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ CourseAccess
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Payment
- ‚úÖ –û—à–∏–±–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
=== [confirmPaymentFromWebhook] –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò ===
  yookassaPaymentId: 2d72xxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  amountFromYookassa: 1000.00
  ‚úÖ –ü–ª–∞—Ç—ë–∂ –Ω–∞–π–¥–µ–Ω:
    paymentId: clxxxxxxxxxxxx
    userId: clxxxxxxxxxxxx
    courseId: clxxxxxxxxxxxx
    amountRub: 1000.00
  üí∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã:
    –û–∂–∏–¥–∞–µ—Ç—Å—è: 1000
    –ü–æ–ª—É—á–µ–Ω–æ: 1000
    –†–∞–∑–Ω–∏—Ü–∞: 0
  ‚úÖ –°—É–º–º–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
  üîÑ –°–æ–∑–¥–∞–Ω–∏–µ CourseAccess –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Payment...
  ‚úÖ CourseAccess —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª—ë–Ω:
    courseId: clxxxxxxxxxxxx
    userId: clxxxxxxxxxxxx
  ‚úÖ Payment –æ–±–Ω–æ–≤–ª—ë–Ω:
    paymentId: clxxxxxxxxxxxx
    status: SUCCEEDED
üéâ –£–°–ü–ï–•! –ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –¥–æ—Å—Ç—É–ø –≤—ã–¥–∞–Ω
=== [confirmPaymentFromWebhook] –ö–û–ù–ï–¶ ===
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (`packages/core/src/services/course/courseService.ts`)

–õ–æ–≥–∏—Ä—É–µ—Ç:
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ (courseType, userId)
- ‚úÖ –ù–∞–π–¥–µ–Ω –ª–∏ –∫—É—Ä—Å
- ‚úÖ –§–ª–∞–≥–∏ isPaid, isPrivate
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ CourseAccess
- ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
=== [checkCourseAccess] –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê ===
  courseType: fitness-basics
  userId: clxxxxxxxxxxxx
  üìã –ö—É—Ä—Å –Ω–∞–π–¥–µ–Ω:
    courseId: clxxxxxxxxxxxx
    isPaid: true
    isPrivate: false
    accessRecordsCount: 1
    accessRecords: [{"userId":"clxxxxxxxxxxxx"}]
  üîê –ü–ª–∞—Ç–Ω—ã–π/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫—É—Ä—Å:
    –ó–∞–ø–∏—Å–µ–π –≤ CourseAccess: 1
    –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –¥–æ—Å—Ç—É–ø –µ—Å—Ç—å
=== [checkCourseAccess] –ö–û–ù–ï–¶ ===
```

## –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ngrok

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å ngrok –¥–ª—è webhook
ngrok http 3000
```

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä `https://abc123.ngrok.io`)

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ÆKassa

1. –ó–∞–π—Ç–∏ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/my)
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
3. –£–∫–∞–∑–∞—Ç—å URL: `https://abc123.ngrok.io/api/v1/payments/webhook`
4. –í–∫–ª—é—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`, `refund.succeeded`

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä

```bash
pnpm dev
```

### –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É

1. –û—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –Ω–∞ `http://localhost:3000`
2. –ó–∞–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
3. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π –∫—É—Ä—Å
4. –ù–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å"
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –ÆKassa: `5555 5555 5555 4444`, –ª—é–±–æ–π —Å—Ä–æ–∫, –ª—é–±–æ–π CVC

### –®–∞–≥ 5: –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å `pnpm dev` –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤—Å–µ –ª–æ–≥–∏:

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞** ‚Äî –ª–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
2. **–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook** ‚Äî –ª–æ–≥–∏ –∏–∑ webhook endpoint
3. **–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã** ‚Äî –ª–æ–≥–∏ –∏–∑ confirmPaymentFromWebhook
4. **–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–∞** ‚Äî –ª–æ–≥–∏ –∏–∑ checkCourseAccess

## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–õ–æ–≥–∏:** –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

**–ü—Ä–∏—á–∏–Ω–∞:** 
- ngrok –Ω–µ –∑–∞–ø—É—â–µ–Ω
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ÆKassa
- –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ ngrok –∞–∫—Ç–∏–≤–µ–Ω
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `pnpm dev` –∑–∞–ø—É—â–µ–Ω

### ‚ùå Webhook –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è (403)

**–õ–æ–≥–∏:** `[payments/webhook] –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω: IP –Ω–µ –≤ whitelist`

**–ü—Ä–∏—á–∏–Ω–∞:** IP –∞–¥—Ä–µ—Å ngrok –Ω–µ –≤ whitelist –ÆKassa (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è ngrok)

**–†–µ—à–µ–Ω–∏–µ:** –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP –≤ `webhook/route.ts` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏:

```typescript
// if (!isYooKassaIP(ip)) {
//   console.warn("[payments/webhook] –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω: IP –Ω–µ –≤ whitelist", { ip });
//   return NextResponse.json({}, { status: 403 });
// }
```

### ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏

**–õ–æ–≥–∏:** `[payments/webhook] Invalid signature`

**–ü—Ä–∏—á–∏–Ω–∞:** `YOOKASSA_SECRET_KEY` –≤ `.env` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–æ–º –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `.env`:
```bash
YOOKASSA_SECRET_KEY=live_–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á
```

### ‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω

**–õ–æ–≥–∏:** `‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω`

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –ü–ª–∞—Ç—ë–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (—Å—Ç–∞—Ç—É—Å –Ω–µ PENDING)
- yookassaPaymentId –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î —Ç–∞–±–ª–∏—Ü—É `Payment`

### ‚ùå –î–æ—Å—Ç—É–ø –Ω–µ –≤—ã–¥–∞—ë—Ç—Å—è

**–õ–æ–≥–∏:** 
```
=== [checkCourseAccess] –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê ===
  ...
  accessRecordsCount: 0
  –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–ø–∏—Å—å –≤ `CourseAccess` –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `confirmPaymentFromWebhook` ‚Äî –±—ã–ª–∞ –ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏?
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î —Ç–∞–±–ª–∏—Ü—É `CourseAccess` ‚Äî –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å?
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –≤–æ–æ–±—â–µ –ø—Ä–∏—à—ë–ª

## –ü–æ—Å–ª–µ –æ—Ç–ª–∞–¥–∫–∏

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –º–æ–∂–Ω–æ:
1. –£–±—Ä–∞—Ç—å —á–∞—Å—Ç—å `console.log` (–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ)
2. –í–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP –¥–ª—è production
3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
