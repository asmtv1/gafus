# Аудит безопасности: регистрация, авторизация, смена и восстановление пароля (apps/web)

**Дата:** 2025-02-09  
**Область:** apps/web + packages/auth + packages/core  
**Задача:** только перечень уязвимостей и план рефактора, без правок кода.

---

## 1. Список уязвимостей и рисков

### 1.1 Регистрация

| # | Уязвимость | Описание | Критичность |
|---|------------|----------|------------|
| R1 | **Слабая политика паролей** | `passwordSchema`: минимум 6 символов, только `[A-Za-z0-9]`. Нет требований к верхнему/нижнему регистру, цифрам, спецсимволам. Рекомендация (auth-implementation-patterns): минимум 12 символов, смешанный регистр, цифра, спецсимвол. | Высокая |
| R2 | **Нет rate limiting** | POST `/api/v1/auth/register` и Server Action `registerUserAction` не ограничивают частоту запросов. Возможна массовая регистрация и DoS. | Высокая |
| R3 | **User enumeration при регистрации** | Ответы `registerUser` и API: «Пользователь с таким телефоном уже существует» / «Пользователь с таким именем уже существует» позволяют проверять занятость телефона и логина. | Средняя |
| R4 | **Нет CSRF для API регистрации** | Маршрут `/api/v1/auth/register` не использует `withCSRFProtection`. При использовании API с другого сайта возможна CSRF-регистрация (если браузер шлёт куки). | Средняя |
| R5 | **Дублирование валидации** | В API route схема Zod слабее (только `min(6)` для пароля), в shared — строже (regex). Риск расхождения и ослабления при изменении только в одном месте. | Низкая |

### 1.2 Авторизация (вход)

| # | Уязвимость | Описание | Критичность |
|---|------------|----------|------------|
| A1 | **Нет rate limiting на логин** | Логин через NextAuth `signIn("credentials")` и проверка `checkUserStateAction` не ограничены по частоте. Возможен перебор паролей по логину. | Высокая |
| A2 | **Раскрытие номера телефона по логину** | `checkUserStateAction(username)` возвращает `{ confirmed, phone }`. По любому существующему username можно узнать номер телефона (E.164). Утечка PII и перебор. | Высокая |
| A3 | **Длинный срок жизни сессии** | JWT и cookie сессии: `maxAge: 30 * 24 * 60 * 60` (30 дней). Увеличенное окно при компрометации токена. | Средняя |
| A4 | **Разные ответы при ошибке входа** | NextAuth `authorize`: «Пользователь не найден» vs «Неверный пароль» — позволяет перечислять зарегистрированные логины. | Средняя |
| A5 | **Логирование чувствительных данных** | В `registerUserAction` и др. в лог передаётся `{ name, phone }` при ошибке. В логах могут оказаться PII. | Низкая |

### 1.3 Восстановление пароля (запрос ссылки)

| # | Уязвимость | Описание | Критичность |
|---|------------|----------|------------|
| P1 | **Нет rate limiting** | POST `/api/v1/auth/password-reset-request` и `sendPasswordResetRequestAction` не лимитированы. Можно массово слать запросы по разным username. | Высокая |
| P2 | **Раскрытие привязки логин–телефон** | `checkPhoneMatchesUsernameAction` возвращает true/false. По перебору пар (username, phone) можно выяснять привязки. Форма показывает: «Телефон не совпадает с именем пользователя». | Высокая |
| P3 | **Утечка данных в Telegram** | В сообщении бота при сбросе пароля передаётся логин и телефон в открытом виде. При компрометации переписки или бота — утечка PII. | Средняя |
| P4 | **Нет CSRF для API** | `/api/v1/auth/password-reset-request` без CSRF. Теоретически возможен CSRF-запрос сброса (отправка ссылки жертве). | Низкая |

### 1.4 Смена пароля по токену (reset-password)

| # | Уязвимость | Описание | Критичность |
|---|------------|----------|------------|
| S1 | **Токен в URL** | Токен передаётся в query: `/reset-password?token=...`. Может попасть в Referer, логи прокси/сервера, историю браузера. | Средняя |
| S2 | **Нет rate limiting** | POST `/api/v1/auth/reset-password` и `resetPasswordAction` не лимитированы. Возможен перебор токенов (UUID v4 — большой перебор, но лимит всё равно нужен). | Средняя |
| S3 | **Слабая политика пароля** | Те же правила, что при регистрации: min 6, только буквы/цифры. | Высокая (см. R1) |
| S4 | **Нет атомарности при сбросе** | В `resetPasswordByToken`: сначала `user.update`, затем `passwordResetToken.delete`. При сбое после update токен может остаться и быть использован повторно. Нужна транзакция. | Средняя |
| S5 | **Форма сброса без CSRF** | Server Action `resetPasswordAction` и API не защищены CSRF. Для действия смены пароля по токену риск ниже (токен секретный), но единообразие и защита API желательны. | Низкая |

### 1.5 Общее и инфраструктура

| # | Уязвимость | Описание | Критичность |
|---|------------|----------|------------|
| O1 | **Пароль в логах при ошибке** | В server-actions при catch логируется `error`; если где-то в стеке попадёт объект с полем password — риск. Сейчас пароль в лог не передаётся явно, но при рефакторинге легко допустить утечку. | Низкая |
| O2 | **Нет единого лимита на длину токена** | В API `reset-password`: token только `min(1)`, в shared схеме — `max(500)`. Слишком длинный token может использоваться для DoS (большие тела/запросы). | Низкая |
| O3 | **Cookie SameSite** | В auth: `sameSite: "lax"`. Для строгой защиты от CSRF часто рекомендуют `strict`, но с учётом OAuth/редиректов «lax» приемлем; стоит зафиксировать в политике. | Инфо |
| O4 | **bcrypt rounds** | В `registerUser` и `resetPasswordByToken` используется `bcrypt.hash(..., 10)`. Рекомендация (auth-implementation-patterns): 12 раундов для лучшей стойкости. | Низкая |

---

## 2. План рефакторинга (без реализации)

### Фаза 1: Критичные и высокоприоритетные

1. **Rate limiting для auth-эндпоинтов**
   - Ввести общий rate limiter (по IP или по IP+userId где есть сессия) для:
     - POST `/api/v1/auth/register`
     - POST `/api/v1/auth/password-reset-request`
     - POST `/api/v1/auth/reset-password`
   - Ограничить логин: либо rate limit на NextAuth API (например, через middleware или обёртку страницы логина), либо капча после N неудачных попыток.
   - Документировать лимиты в `docs/` и в коде.

2. **Убрать раскрытие phone по username**
   - `checkUserStateAction`: не возвращать `phone` клиенту. Возвращать только `confirmed` (и при необходимости маскированный номер для подсказки, например «+7 *** *** ** 12»).
   - Редирект на `/confirm`: не передавать полный `phone` в query. Использовать временный server-side идентификатор (например, зашифрованный/подписанный параметр с сессией или одноразовый код), по которому на сервере определяется phone для проверки подтверждения.

3. **Унифицировать и усилить политику паролей**
   - В `authSchemas.ts`: увеличить минимальную длину (например, до 12), добавить требования: верхний/нижний регистр, цифра, спецсимвол (или явно зафиксировать осознанно слабые правила в политике безопасности).
   - Применить одну и ту же схему в API routes и Server Actions (shared schema).

4. **Устранение user enumeration при регистрации и логине**
   - Регистрация: заменить разные сообщения на одно общее («Не удалось создать аккаунт. Проверьте данные или попробуйте другой способ входа.») и не раскрывать, занят ли телефон или логин.
   - Логин: в NextAuth `authorize` возвращать одну и ту же ошибку при «пользователь не найден» и «неверный пароль» (например, «Неверный логин или пароль»).

### Фаза 2: Средний приоритет

5. **CSRF для публичных auth API**
   - Решить, являются ли `/api/v1/auth/*` только для мобильного/внешнего клиента. Если эти маршруты вызываются из браузера (например, с того же origin) — добавить проверку CSRF (например, `withCSRFProtection` или кастомная проверка заголовка/тела).
   - Документировать, какие клиенты используют API, а какие — Server Actions.

6. **Защита токена сброса пароля**
   - Рассмотреть переход на передачу токена в теле POST (форма с hidden input или заголовок) вместо query. Страница `/reset-password` получает токен один раз (например, по одноразовой ссылке с кодом в path или по POST из письма/бота с form POST), затем форма отправляет токен в теле.
   - Либо оставить token в URL, но добавить предупреждение в документации и в политике (не логировать query, не передавать Referer на сторонние сайты).

7. **Атомарность сброса пароля**
   - В `resetPasswordByToken`: обернуть `user.update` и `passwordResetToken.delete` в `prisma.$transaction`, чтобы токен нельзя было использовать повторно при частичном сбое.

8. **Ограничение раскрытия в восстановлении пароля**
   - В форме «забыли пароль» не показывать явно «телефон не совпадает с именем пользователя». Заменить на нейтральное сообщение («Если указанные данные верны, вам придёт сообщение в Telegram») и всегда показывать его после отправки (как сейчас при успехе).
   - В Telegram-сообщении: не включать телефон в текст или маскировать (например, последние 2–4 цифры).

### Фаза 3: Низкий приоритет и гигиена

9. **Логирование**
   - В auth server-actions и API не логировать phone, username (или логировать только хэш/маску). Добавить в правила проекта запрет логирования паролей и полных PII.

10. **Единая валидация и срок сессии**
    - Вынести валидацию регистрации/сброса пароля в общие схемы (shared) и использовать их и в API, и в Server Actions.
    - Рассмотреть сокращение срока жизни сессии (например, 7 дней) или введение refresh без увеличения риска UX; зафиксировать выбор в политике.

11. **bcrypt и токены**
    - Увеличить cost factor bcrypt до 12 в `registerUser` и `resetPasswordByToken`.
    - В API для `reset-password` ограничить длину token (например, `max(64)` или по длине UUID).

12. **Документация и политика**
    - Обновить `docs/` (например, `apps/web.md` или отдельный security.md): перечень auth-эндпоинтов, политика паролей, rate limits, обработка PII и токенов.
    - Добавить в документацию предупреждение: не логировать query string страницы сброса пароля и не передавать Referer на внешние сайты.

---

## 3. Сводка по приоритетам

| Приоритет | Элементы плана |
|-----------|----------------|
| Критично / высоко | Rate limiting (регистрация, логин, запрос сброса, сброс по токену); не отдавать phone по username; усиление политики паролей; устранение user enumeration (регистрация + логин). |
| Средне | CSRF для auth API; защита/перенос токена сброса из URL; транзакция в resetPasswordByToken; нейтральные сообщения и маскирование в восстановлении и в Telegram. |
| Низко | Логи без PII; единые схемы и лимиты; bcrypt 12; ограничение длины token в API; документация и политика. |

После выполнения рефакторинга рекомендуется повторный прогон чек-листа (auth-implementation-patterns, code-review-excellence Security Review) и при необходимости — ручной тест сценариев (регистрация, логин, сброс, смена пароля).
