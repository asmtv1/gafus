# Политика безопасности auth

Применяется к apps/web и apps/api (auth-эндпоинты).

## Auth API (web)

- `POST /api/v1/auth/register` — регистрация
- `POST /api/v1/auth/check-state` — статус пользователя (confirmed, needsConfirm)
- `POST /api/v1/auth/check-confirmed` — подтверждение по телефону
- `POST /api/v1/auth/check-phone-match` — заглушка (всегда `matches: true`)
- `POST /api/v1/auth/password-reset-request` — запрос сброса пароля
- `POST /api/v1/auth/reset-password` — сброс по токену

Публичные auth API не защищены CSRF по решению: используются и мобильным клиентом; применяются rate limit и CORS.

## Политика паролей

- **Регистрация и сброс пароля:** минимум 8 символов, максимум 100; минимум одна заглавная, одна строчная, одна цифра. Спецсимволы разрешены (латиница, цифры, спецсимволы).
- **Логин:** только проверка на непустой пароль и max 100 символов (не блокировать старых пользователей со слабыми паролями).

## Rate limits (по IP, окно 15 мин)

- register: 5
- login: 10
- password-reset-request: 5
- reset-password: 10

In-memory хранилище: при нескольких инстансах (pod/worker) счётчики не общие; для общего лимита нужен Redis (документировать как ограничение).

## Что не логировать

- Номер телефона (phone) в открытом виде
- Пароль
- В ошибках auth — не раскрывать «телефон занят» / «логин занят» (один общий текст)
- В логах Server Actions и core — не передавать name/phone в контексте logger

## Сброс пароля

- Ссылка из бота ведёт на `/reset-password` без query. В сообщении передаётся 6-значный код; пользователь вводит код и новый пароль на странице.
- API принимает либо `{ code, password }` (сброс по коду), либо `{ token, password }` (по токену, для обратной совместимости). В схеме: `token` max 64 символа, `code` — 6 цифр.

## Сессия (NextAuth)

- maxAge по умолчанию 30 дней; при ужесточении политики — зафиксировать в конфиге и здесь.
