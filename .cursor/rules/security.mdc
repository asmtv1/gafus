---
alwaysApply: true
---

# Security Best Practices

## Authentication
- Use NextAuth.js for authentication
- Import: `import { getServerSession } from "next-auth"`
- Check session in Server Actions and API routes
- Use role-based access control (RBAC)

## Authorization
Для проверки только факта входа в apps/web используй `getCurrentUserId()` из `@shared/utils/getCurrentUserId`. Для проверки роли — `getServerSession(authOptions)` и `authOptions` из `@gafus/auth`:

```typescript
"use server";

import { getServerSession } from "next-auth";
import { authOptions } from "@gafus/auth";

export async function protectedAction() {
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    return { error: "Не авторизован" };
  }

  if (!["ADMIN", "TRAINER"].includes(session.user.role)) {
    return { error: "Недостаточно прав доступа" };
  }

  // ... action logic
}
```

## CSRF Protection
- Use `@gafus/csrf` package
- Validate CSRF tokens in mutations
- Token automatically included in forms

## Input Validation
- Always validate with Zod schemas
- Sanitize user input
- Validate file uploads (type, size)
- Use parameterized queries (Prisma handles this)

## File Uploads
- Validate file type and size (e.g. video: type, max 100MB)
- Return clear error messages in Russian

## Environment Variables
- Never expose secrets to client
- Use `process.env` only in server code
- Validate env vars at startup
- Use `.env.local` for local development

## Best Practices
- Never trust client input
- Use HTTPS in production
- Implement rate limiting
- Log security events
- Keep dependencies updated
- Use Content Security Policy (CSP)
