<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç PWA - –ì–∞—Ñ—É—Å</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #fff;
      }
      .status {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .status h3 {
        margin-top: 0;
        color: #fff;
      }
      .status p {
        margin: 10px 0;
        font-size: 14px;
      }
      .success {
        color: #4ade80;
      }
      .error {
        color: #f87171;
      }
      .warning {
        color: #fbbf24;
      }
      .info {
        color: #60a5fa;
      }
      button {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
        transition: background 0.3s;
      }
      button:hover {
        background: #4338ca;
      }
      button:disabled {
        background: #6b7280;
        cursor: not-allowed;
      }
      .cache-info {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ –¢–µ—Å—Ç PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</h1>

      <div class="status">
        <h3>üì± –°—Ç–∞—Ç—É—Å PWA</h3>
        <p id="pwa-status">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</p>
        <p id="sw-status">–ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker...</p>
        <p id="cache-status">–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à–∏...</p>
      </div>

      <div class="status">
        <h3>üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button id="check-sw" onclick="checkServiceWorker()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SW</button>
        <button id="clear-cache" onclick="clearAllCaches()">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à–∏</button>
        <button id="update-sw" onclick="updateServiceWorker()">–û–±–Ω–æ–≤–∏—Ç—å SW</button>
        <button id="test-offline" onclick="testOffline()">–¢–µ—Å—Ç –æ—Ñ–ª–∞–π–Ω</button>
      </div>

      <div class="status">
        <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—ç—à–∞—Ö</h3>
        <div id="cache-info" class="cache-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div class="status">
        <h3>üìù –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
        <div id="event-log" class="cache-info">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</div>
      </div>
    </div>

    <script>
      let eventLog = [];

      function logEvent(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        eventLog.unshift(logEntry);

        if (eventLog.length > 50) {
          eventLog = eventLog.slice(0, 50);
        }

        document.getElementById("event-log").textContent = eventLog.join("\n");
        console.log(logEntry);
      }

      function updateStatus(elementId, text, className = "") {
        const element = document.getElementById(elementId);
        element.textContent = text;
        element.className = className;
      }

      async function checkPWAStatus() {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Service Worker
          if ("serviceWorker" in navigator) {
            updateStatus("pwa-status", "‚úÖ Service Worker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "success");
            logEvent("Service Worker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º");
          } else {
            updateStatus("pwa-status", "‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "error");
            logEvent("Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º", "error");
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é Service Worker
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            updateStatus(
              "sw-status",
              `‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (${registration.scope})`,
              "success",
            );
            logEvent(`Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${registration.scope}`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (registration.active) {
              logEvent(`Service Worker –∞–∫—Ç–∏–≤–µ–Ω: ${registration.active.state}`);
            }
            if (registration.installing) {
              logEvent(`Service Worker —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è: ${registration.installing.state}`);
            }
            if (registration.waiting) {
              logEvent(`Service Worker –æ–∂–∏–¥–∞–µ—Ç: ${registration.waiting.state}`);
            }
          } else {
            updateStatus("sw-status", "‚ö†Ô∏è Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "warning");
            logEvent("Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "warning");
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à–∏
          await checkCaches();
        } catch (error) {
          logEvent(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PWA: ${error.message}`, "error");
          updateStatus("pwa-status", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "error");
        }
      }

      async function checkCaches() {
        try {
          const cacheNames = await caches.keys();
          if (cacheNames.length > 0) {
            updateStatus("cache-status", `‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫—ç—à–µ–π: ${cacheNames.length}`, "success");
            logEvent(`–ù–∞–π–¥–µ–Ω–æ –∫—ç—à–µ–π: ${cacheNames.length}`);

            let cacheInfo = "";
            for (const name of cacheNames) {
              const cache = await caches.open(name);
              const keys = await cache.keys();
              cacheInfo += `${name}: ${keys.length} –∑–∞–ø–∏—Å–µ–π\n`;
            }
            document.getElementById("cache-info").textContent = cacheInfo;
          } else {
            updateStatus("cache-status", "‚ö†Ô∏è –ö—ç—à–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "warning");
            logEvent("–ö—ç—à–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "warning");
            document.getElementById("cache-info").textContent = "–ö—ç—à–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç";
          }
        } catch (error) {
          logEvent(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫—ç—à–µ–π: ${error.message}`, "error");
          updateStatus("cache-status", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "error");
        }
      }

      async function checkServiceWorker() {
        logEvent("–ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker...");
        await checkPWAStatus();
      }

      async function clearAllCaches() {
        try {
          logEvent("–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫—ç—à–µ–π...");
          const cacheNames = await caches.keys();

          for (const name of cacheNames) {
            await caches.delete(name);
            logEvent(`–£–¥–∞–ª–µ–Ω –∫—ç—à: ${name}`);
          }

          logEvent("–í—Å–µ –∫—ç—à–∏ –æ—á–∏—â–µ–Ω—ã");
          await checkCaches();
        } catch (error) {
          logEvent(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–µ–π: ${error.message}`, "error");
        }
      }

      async function updateServiceWorker() {
        try {
          logEvent("–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Service Worker...");
          const registration = await navigator.serviceWorker.getRegistration();

          if (registration) {
            await registration.update();
            logEvent("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker –∑–∞–ø—Ä–æ—à–µ–Ω–æ");

            // –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            registration.addEventListener("updatefound", () => {
              const newWorker = registration.installing;
              logEvent(`–ù–∞–π–¥–µ–Ω –Ω–æ–≤—ã–π Service Worker: ${newWorker.state}`);

              newWorker.addEventListener("statechange", () => {
                logEvent(`–°–æ—Å—Ç–æ—è–Ω–∏–µ Service Worker –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: ${newWorker.state}`);

                if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                  logEvent("–ù–æ–≤—ã–π Service Worker –≥–æ—Ç–æ–≤ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏");
                  if (confirm("–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?")) {
                    newWorker.postMessage({ type: "SKIP_WAITING" });
                    window.location.reload();
                  }
                }
              });
            });
          } else {
            logEvent("Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "warning");
          }
        } catch (error) {
          logEvent(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Service Worker: ${error.message}`, "error");
        }
      }

      async function testOffline() {
        try {
          logEvent("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞...");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ç–∏
          if (navigator.onLine) {
            logEvent("–°–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞");
          } else {
            logEvent("–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—Ñ–ª–∞–π–Ω)", "warning");
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
          const cacheNames = await caches.keys();
          let offlineResources = 0;

          for (const name of cacheNames) {
            const cache = await caches.open(name);
            const keys = await cache.keys();
            offlineResources += keys.length;
          }

          logEvent(`–î–æ—Å—Ç—É–ø–Ω–æ –æ—Ñ–ª–∞–π–Ω —Ä–µ—Å—É—Ä—Å–æ–≤: ${offlineResources}`);

          // –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Ñ–ª–∞–π–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          try {
            const response = await fetch("/~offline");
            if (response.ok) {
              logEvent("–û—Ñ–ª–∞–π–Ω —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞", "success");
            } else {
              logEvent("–û—Ñ–ª–∞–π–Ω —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞", "warning");
            }
          } catch (error) {
            logEvent("–û—Ñ–ª–∞–π–Ω —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏)", "warning");
          }
        } catch (error) {
          logEvent(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ñ–ª–∞–π–Ω: ${error.message}`, "error");
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener("DOMContentLoaded", () => {
        logEvent("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        checkPWAStatus();

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è Service Worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.addEventListener("message", (event) => {
            logEvent(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç SW: ${JSON.stringify(event.data)}`);
          });

          navigator.serviceWorker.addEventListener("controllerchange", () => {
            logEvent("Service Worker –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è");
          });
        }

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–∏
        window.addEventListener("online", () => {
          logEvent("–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", "success");
        });

        window.addEventListener("offline", () => {
          logEvent("–°–µ—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–∞", "warning");
        });
      });
    </script>
  </body>
</html>
