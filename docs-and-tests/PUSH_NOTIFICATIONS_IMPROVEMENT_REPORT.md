# –û—Ç—á–µ—Ç –æ–± —É–ª—É—á—à–µ–Ω–∏–∏ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞:

Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä —à–∞–≥–∞ –∏ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏.

### –†–µ—à–µ–Ω–∏–µ:

#### 1. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stepTitle` –≤ —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: add_step_title_to_notifications
ALTER TABLE "StepNotification" ADD COLUMN "stepTitle" TEXT;
```

#### 2. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**

- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `stepTitle` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —à–∞–≥–∞
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: `/trainings/${courseId}/${day}`

#### 3. **–£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `startUserStepServerAction`**

```typescript
// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–≥–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
const dayOnCourse = await prisma.dayOnCourse.findFirst({
  where: { courseId, order: day },
  include: {
    day: {
      include: {
        stepLinks: {
          include: { step: true },
        },
      },
    },
    course: true,
  },
});

const step = dayOnCourse.day.stepLinks[stepIndex].step;
const stepTitle = step.title;

// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
const trainingUrl = `/trainings/${courseId}/${day}`;

await createStepNotificationsForUserStep({
  userId,
  day,
  stepIndex,
  durationSec: durationSec,
  maybeUrl: trainingUrl,
  stepTitle,
});
```

#### 4. **–û–±–Ω–æ–≤–ª–µ–Ω push-worker**

```typescript
const stepTitle = notif.stepTitle || `–®–∞–≥ ${notif.stepIndex + 1}`;
const payload = JSON.stringify({
  title: "–®–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω!",
  body: `–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ "${stepTitle}".`,
  icon: "/icons/icon192.png",
  badge: "/icons/badge-72.png",
  data: {
    url: notif.url ?? "https://gafus.ru/",
  },
});
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

#### ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∞—Ç:**

- **–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞** –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞
- **–ü—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É** –Ω–∞ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- **–ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç** —Å –∫–∞–≤—ã—á–∫–∞–º–∏ –≤–æ–∫—Ä—É–≥ –Ω–∞–∑–≤–∞–Ω–∏—è

#### ‚úÖ **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**

- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞** –¥–Ω—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç **—Ç–æ—á–Ω–æ –Ω–∞ –Ω—É–∂–Ω—ã–π –¥–µ–Ω—å**
- –°—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### –ü—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

**–ë—ã–ª–æ:**

```
–®–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω!
–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ —à–∞–≥ 3.
```

**–°—Ç–∞–ª–æ:**

```
–®–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω!
–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å –º—è—á–∏–∫–æ–º".
```

### –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã:

- ‚úÖ `packages/prisma/schema.prisma` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stepTitle`
- ‚úÖ `apps/web/src/lib/StepNotification/createStepNotification.ts` - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `stepTitle`
- ‚úÖ `apps/web/src/lib/training/startUserStepServerAction.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —à–∞–≥–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
- ‚úÖ `packages/worker/src/push-worker.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —à–∞–≥–∞ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
- ‚úÖ `packages/prisma/migrations/20250802115512_add_step_title_to_notifications/` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

‚úÖ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è** –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞** —É—Å–ø–µ—à–Ω–æ
‚úÖ **–õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –æ–±–Ω–æ–≤–ª–µ–Ω–∞
‚úÖ **Push-worker** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ** - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å—Å—ã–ª–æ–∫** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ

–£–ª—É—á—à–µ–Ω–∏–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ! üéâ
