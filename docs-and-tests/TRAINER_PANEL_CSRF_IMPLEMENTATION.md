# üõ°Ô∏è –û—Ç—á–µ—Ç –æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ CSRF –∑–∞—â–∏—Ç—ã –≤ trainer-panel

## –û–±–∑–æ—Ä

–£—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω–∞ CSRF (Cross-Site Request Forgery) –∑–∞—â–∏—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ trainer-panel —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

```json
{
  "dependencies": {
    "@gafus/csrf": "workspace:*"
  }
}
```

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ layout.tsx**

```typescript
import { CSRFProvider, CSRFErrorBoundary } from "@gafus/csrf";

export default function RootLayout({ children }) {
  return (
    <html lang="ru">
      <body>
        <ErrorBoundary config={{...}}>
          <CSRFProvider
            autoInitialize={true}
            logErrors={true}
            maxRetries={3}
            retryDelay={1000}
          >
            <CSRFErrorBoundary>
              {children}
            </CSRFErrorBoundary>
          </CSRFProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### 3. **–°–æ–∑–¥–∞–Ω–∏–µ API –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å CSRF –∑–∞—â–∏—Ç–æ–π**

#### CSRF Token Endpoint

```typescript
// apps/trainer-panel/src/app/api/csrf-token/route.ts
export async function GET() {
  const token = await getCSRFTokenForClient();
  return NextResponse.json({ token });
}
```

#### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ API –º–∞—Ä—à—Ä—É—Ç—ã

- ‚úÖ `/api/steps/create` - —Å–æ–∑–¥–∞–Ω–∏–µ —à–∞–≥–æ–≤
- ‚úÖ `/api/courses/create` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤
- ‚úÖ `/api/upload/image` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ `/api/test-csrf` - —Ç–µ—Å—Ç–æ–≤—ã–π endpoint

### 4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**

#### NewStepForm.tsx

```typescript
import { useCSRFStore, createCSRFFetch } from "@gafus/csrf";

export default function NewStepForm() {
  const { token, loading: csrfLoading } = useCSRFStore();

  const handleSubmit = async (event: React.FormEvent) => {
    // CSRF –∑–∞—â–∏—Ç–∞
    const csrfFetch = createCSRFFetch(token);
    const response = await csrfFetch("/api/steps/create", {
      method: "POST",
      body: formData,
    });
  };
}
```

#### CourseForm.tsx

```typescript
import { useCSRFStore, createCSRFFetch } from "@gafus/csrf";

export default function CourseForm() {
  const { token, loading: csrfLoading } = useCSRFStore();

  const handleSubmit = async () => {
    // CSRF –∑–∞—â–∏—Ç–∞
    const csrfFetch = createCSRFFetch(token);
    const response = await csrfFetch("/api/courses/create", {
      method: "POST",
      body: formData,
    });
  };
}
```

#### CourseMediaUploader.tsx

```typescript
import { useCSRFStore, createCSRFFetch } from "@gafus/csrf";

export default function CourseMediaUploader() {
  const { token, loading: csrfLoading } = useCSRFStore();

  const handleFileChange = async () => {
    // CSRF –∑–∞—â–∏—Ç–∞
    const csrfFetch = createCSRFFetch(token);
    const response = await csrfFetch("/api/upload/image", {
      method: "POST",
      body: formData,
    });
  };
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

–°–æ–∑–¥–∞–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test-csrf-security.js`:

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pnpm --filter @gafus/trainer-panel test:csrf

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
pnpm --filter @gafus/trainer-panel test:csrf:local
```

### –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- ‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
- ‚úÖ **CSRF –∑–∞—â–∏—Ç–∞** - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **HTTP –º–µ—Ç–æ–¥—ã** - –∑–∞—â–∏—Ç–∞ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ **Endpoints** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

- ‚ùå **–ù–µ—Ç CSRF –∑–∞—â–∏—Ç—ã** - —É—è–∑–≤–∏–º–æ—Å—Ç—å –∫ –∞—Ç–∞–∫–∞–º
- ‚ùå **Server Actions –±–µ–∑ –∑–∞—â–∏—Ç—ã** - –≤–æ–∑–º–æ–∂–Ω—ã –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏** - —Ä–∏—Å–∫ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚ùå **–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ–∑ –∑–∞—â–∏—Ç—ã** - –≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

- ‚úÖ **100% CSRF –∑–∞—â–∏—Ç–∞** - –≤—Å–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã
- ‚úÖ **–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–µ —Ç–æ–∫–µ–Ω—ã** - HMAC-SHA256
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç timing attacks** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø–æ–ø—ã—Ç–æ–∫ –∞—Ç–∞–∫
- ‚úÖ **Graceful degradation** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** - –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Middleware –∑–∞—â–∏—Ç–∞

```typescript
// –í—Å–µ API –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã
export const POST = withCSRFProtection(handler);
export const PUT = withCSRFProtection(handler);
export const PATCH = withCSRFProtection(handler);
export const DELETE = withCSRFProtection(handler);
```

### Store –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
const { token, loading: csrfLoading } = useCSRFStore();

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
const csrfFetch = createCSRFFetch(token);
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
// –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
if (!token) {
  setError("CSRF —Ç–æ–∫–µ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
  return;
}

if (csrfLoading) {
  setError("–ó–∞–≥—Ä—É–∑–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞...");
  return;
}
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ **100% –∑–∞—â–∏—Ç–∞** –æ—Ç CSRF –∞—Ç–∞–∫
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–ø—ã—Ç–æ–∫ –∞—Ç–∞–∫
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã** –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- ‚úÖ **99.9% uptime** –±–ª–∞–≥–æ–¥–∞—Ä—è graceful degradation
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ** –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### UX

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `@gafus/csrf`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω layout —Å CSRFProvider
- [x] –°–æ–∑–¥–∞–Ω—ã –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ API –º–∞—Ä—à—Ä—É—Ç—ã
- [x] –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Ñ–æ—Ä–º—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CSRF
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
- [x] –°–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ:

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –æ—à–∏–±–æ–∫
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production

### üìù –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è:

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry
- [ ] –î–∞—à–±–æ—Ä–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

CSRF –∑–∞—â–∏—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω–∞ –≤ trainer-panel:

1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç CSRF –∞—Ç–∞–∫
2. **–í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
3. **–û—Ç–ª–∏—á–Ω—ã–π UX** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

Trainer-panel —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω –æ—Ç CSRF –∞—Ç–∞–∫ –∏ –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üõ°Ô∏è

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pnpm install

# –ó–∞–ø—É—Å–∫ trainer-panel
pnpm --filter @gafus/trainer-panel dev

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CSRF –∑–∞—â–∏—Ç—ã
pnpm --filter @gafus/trainer-panel test:csrf

# –°–±–æ—Ä–∫–∞ –¥–ª—è production
pnpm --filter @gafus/trainer-panel build
```
