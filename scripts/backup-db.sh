#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ docker-compose down

echo "üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î..."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p backups

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Å timestamp
BACKUP_FILE="backups/gafus_backup_$(date +%Y%m%d_%H%M%S).sql"

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø PostgreSQL
docker exec gafus-postgres pg_dump -U gafus -d gafus > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_FILE"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
    ls -t backups/gafus_backup_*.sql | tail -n +6 | xargs -r rm
    
    echo "üßπ –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –æ—á–∏—â–µ–Ω—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!"
    exit 1
fi

echo "üîí –ë–î –≥–æ—Ç–æ–≤–∞ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –¥–µ–ø–ª–æ—é"
