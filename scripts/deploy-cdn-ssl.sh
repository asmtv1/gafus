#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è SSL —Ä–µ—à–µ–Ω–∏—è –¥–ª—è CDN –¥–æ–º–µ–Ω–∞ gafus-media.gafus.ru
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

set -e

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ SSL —Ä–µ—à–µ–Ω–∏—è –¥–ª—è CDN –¥–æ–º–µ–Ω–∞ gafus-media.gafus.ru"
echo "================================================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "ci-cd/docker/docker-compose.prod.yml" ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker Compose!"
    exit 1
fi

echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS –¥–ª—è gafus-media.gafus.ru..."
if nslookup gafus-media.gafus.ru > /dev/null 2>&1; then
    echo "‚úÖ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ùå DNS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è gafus-media.gafus.ru!"
    echo "   –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CNAME –∑–∞–ø–∏—Å—å: gafus-media ‚Üí 17df3fb20ae034d3.a.yccdn.cloud.yandex.net"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç..."
if [ -f "ci-cd/certbot/conf/live/gafus.ru/fullchain.pem" ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –¥–æ–º–µ–Ω gafus-media.gafus.ru –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    if openssl x509 -in ci-cd/certbot/conf/live/gafus.ru/fullchain.pem -text -noout | grep -q "gafus-media.gafus.ru"; then
        echo "‚úÖ –î–æ–º–µ–Ω gafus-media.gafus.ru —É–∂–µ –≤–∫–ª—é—á–µ–Ω –≤ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
        NEED_NEW_CERT=false
    else
        echo "‚ö†Ô∏è  –î–æ–º–µ–Ω gafus-media.gafus.ru –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
        NEED_NEW_CERT=true
    fi
else
    echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
    NEED_NEW_CERT=true
fi

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$NEED_NEW_CERT" = true ]; then
    echo "üîê –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –¥–æ–º–µ–Ω–æ–º gafus-media.gafus.ru..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    if ./scripts/create-ssl-for-cdn.sh; then
        echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        exit 1
    fi
else
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º..."
    cd ci-cd/docker
    docker-compose restart nginx
    cd ../..
fi

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ nginx
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ nginx..."
sleep 10

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞ gafus-media.gafus.ru..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç..."
if curl -s -I http://gafus-media.gafus.ru/uploads/course-logo.webp | grep -q "301\|302"; then
    echo "‚úÖ HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ö†Ô∏è  HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTPS –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTPS –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."
if curl -s -f https://gafus-media.gafus.ru/uploads/course-logo.webp > /dev/null 2>&1; then
    echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è gafus-media.gafus.ru!"
    SSL_WORKING=true
else
    echo "‚ö†Ô∏è  HTTPS –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
    SSL_WORKING=false
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç..."
if openssl s_client -connect gafus-media.gafus.ru:443 -servername gafus-media.gafus.ru < /dev/null 2>/dev/null | openssl x509 -noout -text | grep -q "gafus-media.gafus.ru"; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –¥–æ–º–µ–Ω gafus-media.gafus.ru"
else
    echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –º–æ–∂–µ—Ç –Ω–µ –ø–æ–∫—Ä—ã–≤–∞—Ç—å –¥–æ–º–µ–Ω gafus-media.gafus.ru"
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
echo "üìã –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
if curl -s -f https://gafus-media.gafus.ru/uploads/courses/3122311.webp > /dev/null 2>&1; then
    echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ HTTPS"
else
    echo "‚ö†Ô∏è  –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi

echo ""
echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "=========================="

if [ "$SSL_WORKING" = true ]; then
    echo "‚úÖ SSL –¥–ª—è gafus-media.gafus.ru –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "üì± –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
else
    echo "‚ö†Ô∏è  SSL –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "   - DNS —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 24 —á–∞—Å–æ–≤)"
    echo "   - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ Yandex CDN"
    echo "   - nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
fi

echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
echo ""
echo "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: docs/CDN_SSL_SETUP.md"
