#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º gafus-media.gafus.ru

set -e

echo "üîê –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è –¥–æ–º–µ–Ω–∞ gafus-media.gafus.ru..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å Docker Compose
cd "$(dirname "$0")/../ci-cd/docker"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx –∑–∞–ø—É—â–µ–Ω
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx..."
if ! docker-compose ps nginx | grep -q "Up"; then
    echo "‚ùå Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º..."
    docker-compose up -d nginx
    sleep 5
fi

# –°–æ–∑–¥–∞–µ–º SSL challenge –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL challenge –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
if [ ! -f "../nginx/conf.d/gafus.ru.ssl-challenge.conf" ]; then
    echo "‚ùå SSL challenge –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
docker-compose restart nginx

# –ñ–¥–µ–º, –ø–æ–∫–∞ nginx –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ nginx..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 80
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å nginx –Ω–∞ –ø–æ—Ä—Ç—É 80..."
if ! curl -s -f http://localhost/.well-known/acme-challenge/test > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Nginx –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
fi

# –û–±–Ω–æ–≤–ª—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üîê –û–±–Ω–æ–≤–ª—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –Ω–æ–≤—ã–º –¥–æ–º–µ–Ω–æ–º..."
docker-compose run --rm certbot

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–∑–¥–∞–ª—Å—è
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
if [ -f "../certbot/conf/live/gafus.ru/fullchain.pem" ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ
    echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ:"
    openssl x509 -in ../certbot/conf/live/gafus.ru/fullchain.pem -text -noout | grep -A 5 "Subject Alternative Name"
else
    echo "‚ùå SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å –Ω–æ–≤—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Å –Ω–æ–≤—ã–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º..."
docker-compose restart nginx

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!"
echo "üåê –¢–µ–ø–µ—Ä—å –¥–æ–º–µ–Ω gafus-media.gafus.ru –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å HTTPS"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞..."
sleep 5

if curl -s -f https://gafus-media.gafus.ru/uploads/course-logo.webp > /dev/null 2>&1; then
    echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è gafus-media.gafus.ru!"
else
    echo "‚ö†Ô∏è  HTTPS –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
fi

echo "üéâ –ì–æ—Ç–æ–≤–æ! SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω."
