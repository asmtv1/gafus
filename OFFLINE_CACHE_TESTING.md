# Тестирование офлайн режима и кэширования

## Обзор изменений

Реализована офлайн-безопасная система кэширования, которая:

1. **Не инвалидирует кэш в офлайн режиме** - пользователь видит свой прогресс даже без интернета
2. **Добавляет действия в очередь синхронизации** - при восстановлении соединения все синхронизируется
3. **Обновляет UI оптимистично** - пользователь сразу видит изменения
4. **Автоматически синхронизирует кэш** - при восстановлении соединения

## Как тестировать

### 1. Запуск приложения

```bash
pnpm run start
```

### 2. Открытие тестового интерфейса

В development режиме в правом верхнем углу появится компонент "Offline Cache Tester" с информацией о:
- Онлайн статусе
- Количестве действий в очереди синхронизации
- Времени последней синхронизации
- Ошибках синхронизации

### 3. Тестирование офлайн режима

#### Шаг 1: Подготовка
1. Откройте приложение в браузере
2. Войдите в систему
3. Перейдите на страницу тренировок
4. Убедитесь, что тестовый компонент показывает "Online: Yes"

#### Шаг 2: Симуляция офлайн режима
1. Откройте DevTools (F12)
2. Перейдите на вкладку "Network"
3. Установите "Offline" в выпадающем списке
4. Или используйте команду в консоли: `navigator.onLine = false`

#### Шаг 3: Тестирование в офлайне
1. Завершите шаг тренировки
2. Проверьте, что UI обновился (шаг помечен как завершенный)
3. Проверьте тестовый компонент - должно показать "Online: No"
4. Проверьте, что в очереди появилось действие (Queue: 1+ actions)

#### Шаг 4: Восстановление соединения
1. В DevTools установите "Online" обратно
2. Или используйте команду: `navigator.onLine = true`
3. Нажмите кнопку "Sync" в тестовом компоненте
4. Проверьте, что очередь очистилась (Queue: 0 actions)

### 4. Проверка логов

В консоли браузера должны появиться логи:

```
[Cache] Skipping cache invalidation - user is offline (userId: ...)
[Cache] Cache invalidation action queued for offline sync (userId: ...)
[OfflineStore] Cache invalidation synced for user ...
```

### 5. Тестирование кнопок

- **Clear** - очищает очередь синхронизации
- **Sync** - принудительно синхронизирует очередь (только если онлайн)
- **Test Cache** - тестирует инвалидацию кэша

## Ожидаемое поведение

### ✅ В офлайн режиме:
- Пользователь видит свой прогресс
- UI обновляется мгновенно
- Действия добавляются в очередь синхронизации
- Кэш НЕ инвалидируется

### ✅ При восстановлении соединения:
- Очередь автоматически синхронизируется
- Кэш обновляется с сервера
- UI остается актуальным

### ✅ В онлайн режиме:
- Кэш инвалидируется как обычно
- UI обновляется в реальном времени
- Очередь синхронизации пуста

## Файлы изменений

1. `apps/web/src/shared/lib/actions/invalidateCoursesCache.ts` - офлайн-безопасная инвалидация
2. `apps/web/src/shared/lib/training/updateUserStepStatus.ts` - обновленная логика
3. `apps/web/src/features/training/components/AccordionStep.tsx` - оптимистичное обновление UI
4. `apps/web/src/shared/stores/offlineStore.ts` - поддержка инвалидации кэша
5. `apps/web/src/shared/utils/offlineCacheUtils.ts` - утилиты для офлайн режима
6. `apps/web/src/shared/components/ui/OfflineCacheTester.tsx` - тестовый компонент

## Устранение проблем

### Проблема: Тестовый компонент не появляется
**Решение:** Убедитесь, что `NODE_ENV=development`

### Проблема: Очередь не синхронизируется
**Решение:** Проверьте, что `navigator.onLine = true` и нет ошибок в консоли

### Проблема: Кэш инвалидируется в офлайне
**Решение:** Проверьте, что используется новая версия `invalidateUserProgressCache` с параметром `force: false`

## Дополнительные команды для тестирования

```javascript
// Симуляция офлайн режима
navigator.onLine = false;
window.dispatchEvent(new Event('offline'));

// Симуляция онлайн режима
navigator.onLine = true;
window.dispatchEvent(new Event('online'));

// Проверка статуса очереди
window.gafusOfflineStore = useOfflineStore.getState();
console.log(window.gafusOfflineStore.syncQueue);
```
