name: Build Single Container

on:
  workflow_dispatch:
    inputs:
      container:
        description: "Container to build and deploy"
        required: true
        type: choice
        options:
          - web
          - trainer-panel
          - error-dashboard
          - admin-panel
          - worker
          - bull-board
          - telegram-bot
          - prisma
      deploy:
        description: "Deploy to server after build"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: asmtv1

jobs:
  # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  prepare-deps:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      pnpm-cache-key: ${{ steps.pnpm-cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate cache keys
        id: cache-key
        run: |
          echo "key=${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('packages/**/src/**', 'apps/**/src/**') }}" >> $GITHUB_OUTPUT

      - name: Generate pnpm cache key
        id: pnpm-cache-key
        run: echo "key=${{ hashFiles('**/pnpm-lock.yaml') }}-pnpm-store" >> $GITHUB_OUTPUT

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ steps.pnpm-cache-key.outputs.key }}
          restore-keys: |
            ${{ hashFiles('**/pnpm-lock.yaml') }}-pnpm-store

      - name: Install dependencies
        run: |
          pnpm config set store-dir ~/.pnpm-store
          pnpm config set verify-store-integrity false
          pnpm config set auto-install-peers true
          pnpm config set dedupe-peer-dependents false
          pnpm install --frozen-lockfile --prefer-offline

      - name: Generate Prisma Client
        run: |
          cd packages/prisma
          cp schema.prisma schema.prisma.bak
          awk 'BEGIN{skip=0} /^generator erd \{/{skip=1} skip && /^\}/{skip=0; next} !skip {print}' schema.prisma > schema.tmp && mv schema.tmp schema.prisma
          pnpm db:generate
          mv schema.prisma.bak schema.prisma

      - name: Build packages
        run: |
          # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ logger Ğ¸ prisma Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ (Ğ±ĞµĞ· turbo) Ğ¸Ğ·-Ğ·Ğ° Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          # logger Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ prisma Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸, Ğ½Ğ¾ TypeScript Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ‚Ğ¸Ğ¿Ñ‹ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ğ¸
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ logger Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼, Ñ‚Ğ°Ğº ĞºĞ°Ğº prisma Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½ĞµĞ³Ğ¾ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
          cd packages/logger && pnpm build && cd ../..
          # ĞŸĞ¾ÑĞ»Ğµ ÑĞ±Ğ¾Ñ€ĞºĞ¸ logger, ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ prisma (Ğ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ logger)
          cd packages/prisma && pnpm build && cd ../..
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ core Ğ¿Ğ¾ÑĞ»Ğµ prisma Ğ¸ logger (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½Ğ¸Ñ…)
          cd packages/core && pnpm build && cd ../..
          # Ğ—Ğ°Ñ‚ĞµĞ¼ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· turbo
          pnpm build --filter=@gafus/* --filter=!@gafus/prisma --filter=!@gafus/logger --filter=!@gafus/core

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/dist
            packages/*/.prisma
            ~/.pnpm-store
          key: ${{ steps.cache-key.outputs.key }}-deps
          restore-keys: |
            ${{ hashFiles('**/pnpm-lock.yaml') }}-deps

  # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
  set-container-config:
    runs-on: ubuntu-latest
    outputs:
      dockerfile: ${{ steps.config.outputs.dockerfile }}
      tag: ${{ steps.config.outputs.tag }}
      app-name: ${{ steps.config.outputs.app-name }}
    steps:
      - name: Set container configuration
        id: config
        run: |
          case "${{ github.event.inputs.container }}" in
            web)
              echo "dockerfile=Dockerfile-web-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-web" >> $GITHUB_OUTPUT
              echo "app-name=web" >> $GITHUB_OUTPUT
              ;;
            trainer-panel)
              echo "dockerfile=Dockerfile-trainer-panel-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-trainer-panel" >> $GITHUB_OUTPUT
              echo "app-name=trainer-panel" >> $GITHUB_OUTPUT
              ;;
            error-dashboard)
              echo "dockerfile=Dockerfile-error-dashboard-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-error-dashboard" >> $GITHUB_OUTPUT
              echo "app-name=error-dashboard" >> $GITHUB_OUTPUT
              ;;
            admin-panel)
              echo "dockerfile=Dockerfile-admin-panel-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-admin-panel" >> $GITHUB_OUTPUT
              echo "app-name=admin-panel" >> $GITHUB_OUTPUT
              ;;
            worker)
              echo "dockerfile=Dockerfile-worker-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-worker" >> $GITHUB_OUTPUT
              echo "app-name=worker" >> $GITHUB_OUTPUT
              ;;
            bull-board)
              echo "dockerfile=Dockerfile-bull-board-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-bull-board" >> $GITHUB_OUTPUT
              echo "app-name=bull-board" >> $GITHUB_OUTPUT
              ;;
            telegram-bot)
              echo "dockerfile=Dockerfile-telegram-bot-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-telegram-bot" >> $GITHUB_OUTPUT
              echo "app-name=telegram-bot" >> $GITHUB_OUTPUT
              ;;
            prisma)
              echo "dockerfile=Dockerfile-prisma-optimized" >> $GITHUB_OUTPUT
              echo "tag=gafus-prisma" >> $GITHUB_OUTPUT
              echo "app-name=prisma" >> $GITHUB_OUTPUT
              ;;
          esac

  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Next.js Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ)
  build-app:
    needs: [prepare-deps, set-container-config]
    if: |
      github.event.inputs.container == 'web' ||
      github.event.inputs.container == 'trainer-panel' ||
      github.event.inputs.container == 'error-dashboard' ||
      github.event.inputs.container == 'admin-panel'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/dist
            packages/*/.prisma
            ~/.pnpm-store
          key: ${{ needs.prepare-deps.outputs.cache-key }}-deps

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ needs.prepare-deps.outputs.pnpm-cache-key }}
          restore-keys: |
            ${{ hashFiles('**/pnpm-lock.yaml') }}-pnpm-store

      - name: Install dependencies
        run: |
          pnpm config set store-dir ~/.pnpm-store
          pnpm config set verify-store-integrity false
          pnpm config set auto-install-peers true
          pnpm config set dedupe-peer-dependents false
          pnpm install --frozen-lockfile --prefer-offline --offline

      - name: Build ${{ needs.set-container-config.outputs.app-name }}
        run: |
          cd apps/${{ needs.set-container-config.outputs.app-name }}
          pnpm build

      - name: Cache app build
        uses: actions/cache@v4
        with:
          path: |
            apps/${{ needs.set-container-config.outputs.app-name }}/.next
            apps/${{ needs.set-container-config.outputs.app-name }}/dist
          key: ${{ needs.prepare-deps.outputs.cache-key }}-${{ needs.set-container-config.outputs.app-name }}-build

  # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Docker Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
  prepare-docker:
    needs: [prepare-deps, set-container-config]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿ÑƒÑˆ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
  build-and-push:
    needs: [prepare-docker, set-container-config]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push ${{ needs.set-container-config.outputs.tag }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ci-cd/docker/${{ needs.set-container-config.outputs.dockerfile }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ needs.set-container-config.outputs.tag }}:latest
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/gafus-base:latest
          cache-to: |
            type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  deploy:
    needs: [build-and-push, set-container-config]
    if: github.event.inputs.deploy == 'true'
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ needs.set-container-config.outputs.tag }} to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.GAFUS_SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 30m
          script: |
            set -e
            echo "ğŸš€ Deploying ${{ needs.set-container-config.outputs.tag }} to production..."

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              apt-get update
              apt-get install -y apt-transport-https ca-certificates gnupg lsb-release curl
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
              echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu focal stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
              apt-get update
              apt-get install -y docker-ce docker-ce-cli containerd.io
              systemctl start docker
              systemctl enable docker
            fi

            # Install Docker Compose if not present
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Installing Docker Compose..."
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi

            # Login to GitHub Container Registry
            echo "ğŸ” Logging in to GitHub Container Registry..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u asmtv1 --password-stdin

            # Navigate to project directory
            cd /root/gafus || {
              echo "Directory /root/gafus not found, creating it..."
              mkdir -p /root/gafus
              cd /root/gafus
            }

            # Check if .env file exists, create if not
            if [ ! -f ci-cd/docker/.env ]; then
              echo "âš ï¸ .env file not found, creating from GitHub Secrets..."
              {
                echo "# Database"
                echo "POSTGRES_DB=gafus"
                echo "POSTGRES_USER=gafus"
                echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
                echo "DATABASE_URL=postgresql://gafus:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/gafus"
                echo ""
                echo "# Redis"
                echo "REDIS_URL=redis://redis:6379"
                echo ""
                echo "# Telegram Bot"
                echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}"
                echo ""
                echo "# NextAuth ÑĞµĞºÑ€ĞµÑ‚Ñ‹"
                echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"
                echo ""
                echo "# URLs Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹"
                echo "NEXTAUTH_URL=https://gafus.ru"
                echo "TRAINER_PANEL_URL=https://trainer-panel.gafus.ru"
                echo "ERROR_DASHBOARD_URL=https://monitor.gafus.ru"
                echo "ERROR_DASHBOARD_INTERNAL_URL=http://gafus-error-dashboard:3005"
                echo ""
                echo "# Cookie Ğ´Ğ¾Ğ¼ĞµĞ½"
                echo "AUTH_COOKIE_DOMAIN=.gafus.ru"
                echo ""
                echo "# VAPID ĞºĞ»ÑÑ‡Ğ¸ Ğ´Ğ»Ñ Push ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
                echo "VAPID_PUBLIC_KEY=${{ secrets.VAPID_PUBLIC_KEY }}"
                echo "VAPID_PRIVATE_KEY=${{ secrets.VAPID_PRIVATE_KEY }}"
                echo "VAPID_SUBJECT=mailto:admin@gafus.ru"
                echo ""
                echo "# Yandex Cloud CDN"
                echo "YC_ACCESS_KEY_ID=${{ secrets.YC_ACCESS_KEY_ID }}"
                echo "YC_SECRET_ACCESS_KEY=${{ secrets.YC_SECRET_ACCESS_KEY }}"
                echo ""
                echo "# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ²Ğ¸Ğ´ĞµĞ¾ (HLS)"
                echo "VIDEO_ACCESS_SECRET=${{ secrets.VIDEO_ACCESS_SECRET }}"
                echo "NEXT_PUBLIC_ENABLE_HLS_PROTECTION=${{ secrets.NEXT_PUBLIC_ENABLE_HLS_PROTECTION || 'true' }}"
                echo ""
                echo "# Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
                echo "DISABLE_CONSOLE_LOGGING=true"
                echo ""
                echo "# Next.js Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ"
                echo "NEXT_PUBLIC_SITE_URL=https://gafus.ru"
                echo "NEXT_PUBLIC_TRAINER_PANEL_URL=https://trainer.gafus.ru"
                echo ""
                echo "# ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ±Ğ°Ğ½Ğ´Ğ»Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸)"
                echo "ANALYZE=false"
                echo ""
                echo "# CSRF Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°"
                echo "CSRF_STRICT=false"
                echo ""
                echo "# Grafana"
                echo "GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER }}"
                echo "GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}"
                echo "GRAFANA_SECRET_KEY=${{ secrets.GRAFANA_SECRET_KEY }}"
              } > ci-cd/docker/.env
              chmod 600 ci-cd/docker/.env
              echo "âœ… .env file created"
            else
              echo "âœ… .env file exists"
            fi

            # Pull latest image
            echo "ğŸ“¥ Pulling latest ${{ needs.set-container-config.outputs.tag }} image..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ needs.set-container-config.outputs.tag }}:latest

            # Restart specific container
            echo "ğŸ”„ Restarting ${{ needs.set-container-config.outputs.tag }} container..."
            docker-compose -f ci-cd/docker/docker-compose.prod.yml up -d --force-recreate --no-deps ${{ github.event.inputs.container }} || {
              echo "âš ï¸ Container restart failed, trying to start it..."
              docker-compose -f ci-cd/docker/docker-compose.prod.yml up -d ${{ github.event.inputs.container }}
            }

            # Wait for container to be ready
            echo "â³ Waiting for container to be ready..."
            sleep 10

            # Check container status
            if docker ps | grep -q "gafus-${{ github.event.inputs.container }}"; then
              echo "âœ… Container ${{ needs.set-container-config.outputs.tag }} deployed successfully!"
              docker ps | grep "gafus-${{ github.event.inputs.container }}"
            else
              echo "âŒ Container ${{ needs.set-container-config.outputs.tag }} failed to start"
              docker logs gafus-${{ github.event.inputs.container }} || echo "Could not fetch logs"
              exit 1
            fi

            # Cleanup old images
            docker image prune -f || true

