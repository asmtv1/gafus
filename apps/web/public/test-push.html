<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîî –¢–µ—Å—Ç Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>

      <div id="status" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...</div>

      <div>
        <button id="checkStatus">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <button id="requestPermission">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</button>
        <button id="testNotification">–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <button id="testPush">–¢–µ—Å—Ç Push</button>
        <button id="clearLog">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      const log = document.getElementById("log");
      const status = document.getElementById("status");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logEntry.style.color = type === "error" ? "red" : type === "success" ? "green" : "black";
        log.appendChild(logEntry);
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message, type = "info") {
        status.textContent = message;
        status.className = `status ${type}`;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
      function checkSupport() {
        addLog("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...");

        if (!("Notification" in window)) {
          addLog("‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ", "error");
          updateStatus("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è", "error");
          return false;
        }

        if (!("serviceWorker" in navigator)) {
          addLog("‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "error");
          updateStatus("Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "error");
          return false;
        }

        if (!("PushManager" in window)) {
          addLog("‚ùå Push API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "error");
          updateStatus("Push API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "error");
          return false;
        }

        addLog("‚úÖ –í—Å–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è", "success");
        return true;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
      function checkPermissionStatus() {
        addLog("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π...");

        const permission = Notification.permission;
        addLog(`üì± –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${permission}`);

        if (permission === "granted") {
          updateStatus("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ ‚úÖ", "success");
        } else if (permission === "denied") {
          updateStatus("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚ùå", "error");
        } else {
          updateStatus("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ ‚è≥", "warning");
        }

        return permission;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker
      async function checkServiceWorker() {
        addLog("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker...");

        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            addLog(`‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${registration.scope}`);
            addLog(`üì± –ê–∫—Ç–∏–≤–Ω—ã–π Service Worker: ${registration.active ? "–î–∞" : "–ù–µ—Ç"}`);
            addLog(`üîÑ –û–∂–∏–¥–∞—é—â–∏–π Service Worker: ${registration.waiting ? "–î–∞" : "–ù–µ—Ç"}`);
          } else {
            addLog("‚ùå Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "error");
          }
          return registration;
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Service Worker: ${error.message}`, "error");
          return null;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º Push-–ø–æ–¥–ø–∏—Å–∫—É
      async function checkPushSubscription() {
        addLog("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Push-–ø–æ–¥–ø–∏—Å–∫—É...");

        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();

          if (subscription) {
            addLog("‚úÖ Push-–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞", "success");
            addLog(`üîó Endpoint: ${subscription.endpoint.substring(0, 50)}...`);
            addLog(`üîë Keys: ${JSON.stringify(subscription.toJSON().keys)}`);
          } else {
            addLog("‚ùå Push-–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", "warning");
          }

          return subscription;
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Push-–ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, "error");
          return null;
        }
      }

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
      async function requestNotificationPermission() {
        addLog("üîî –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...");

        try {
          const permission = await Notification.requestPermission();
          addLog(`üì± –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: ${permission}`);

          if (permission === "granted") {
            updateStatus("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ ‚úÖ", "success");
            addLog("‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å push-–ø–æ–¥–ø–∏—Å–∫—É", "success");
          } else {
            updateStatus("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚ùå", "error");
            addLog("‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", "error");
          }

          return permission;
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${error.message}`, "error");
          return null;
        }
      }

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—ã—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      function testNotification() {
        addLog("üîî –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—ã—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...");

        if (Notification.permission !== "granted") {
          addLog("‚ùå –ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "error");
          return;
        }

        try {
          const notification = new Notification("–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", {
            body: "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –ì–∞—Ñ—É—Å",
            icon: "/icons/icon192.png",
            badge: "/icons/badge-72.png",
            tag: "test",
            data: { url: "/" },
          });

          addLog("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ", "success");

          notification.onclick = () => {
            addLog("üëÜ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–∫–Ω—É—Ç–æ");
            window.focus();
          };
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`, "error");
        }
      }

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Service Worker
      async function testPushNotification() {
        addLog("üîî –¢–µ—Å—Ç–∏—Ä—É–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Service Worker...");

        try {
          const registration = await navigator.serviceWorker.ready;

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Service Worker
          registration.active.postMessage({
            type: "TEST_PUSH",
            data: {
              title: "–¢–µ—Å—Ç Push",
              body: "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Service Worker",
              icon: "/icons/icon192.png",
            },
          });

          addLog("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Service Worker", "success");
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è push: ${error.message}`, "error");
        }
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      async function performFullCheck() {
        addLog("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É...");

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
        if (!checkSupport()) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        checkPermissionStatus();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker
        await checkServiceWorker();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Push-–ø–æ–¥–ø–∏—Å–∫—É
        await checkPushSubscription();

        addLog("‚úÖ –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById("checkStatus").addEventListener("click", performFullCheck);
      document
        .getElementById("requestPermission")
        .addEventListener("click", requestNotificationPermission);
      document.getElementById("testNotification").addEventListener("click", testNotification);
      document.getElementById("testPush").addEventListener("click", testPushNotification);
      document.getElementById("clearLog").addEventListener("click", () => {
        log.innerHTML = "";
        addLog("üßπ –õ–æ–≥ –æ—á–∏—â–µ–Ω");
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("load", () => {
        addLog("üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
        performFullCheck();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
      navigator.serviceWorker.addEventListener("message", (event) => {
        addLog(`üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Service Worker: ${JSON.stringify(event.data)}`);
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Service Worker
      navigator.serviceWorker.addEventListener("error", (event) => {
        addLog(
          `‚ùå –û—à–∏–±–∫–∞ Service Worker: ${event.error?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`,
          "error",
        );
      });
    </script>
  </body>
</html>
