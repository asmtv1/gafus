<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è Safari –ø–æ–¥–ø–∏—Å–∫–∞</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #856404;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: #721c24;
      }
      button {
        background-color: #007AFF;
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
      }
      button:hover {
        background-color: #0056CC;
      }
      button:disabled {
        background-color: #8E8E93;
        cursor: not-allowed;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 13px;
        line-height: 1.4;
      }
      .step {
        margin: 20px 0;
        padding: 15px;
        border-left: 4px solid #007AFF;
        background-color: #f8f9fa;
      }
      .endpoint-info {
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        font-family: monospace;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üçé –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è Safari –ø–æ–¥–ø–∏—Å–∫–∞</h1>
      
      <div class="warning">
        <h3>‚ö†Ô∏è –í–∞–∂–Ω–æ!</h3>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è push-–ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è Safari –Ω–∞ iOS.</p>
        <p><strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:</strong></p>
        <ul>
          <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Safari –Ω–∞ iOS</li>
          <li>–î–æ–±–∞–≤—å—Ç–µ –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</li>
          <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞</li>
          <li>–ó–∞–ø—Ä–æ—Å–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
        </ul>
      </div>

      <div id="status" class="warning">–ü—Ä–æ–≤–µ—Ä—è–µ–º Safari...</div>

      <div class="step">
        <h3>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è</h3>
        <button id="checkEnvironment">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ</button>
        <button id="checkPWA">üì± –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PWA —Ä–µ–∂–∏–º</button>
      </div>

      <div class="step">
        <h3>–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
        <button id="createSubscription">üöÄ –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button id="forceAPNS">üçé –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ APNS</button>
        <button id="clearSubscription">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </div>

      <div class="step">
        <h3>–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <button id="testNotification">üîî –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <button id="testPush">üöÄ –¢–µ—Å—Ç Push</button>
      </div>

      <div class="step">
        <h3>–£—Ç–∏–ª–∏—Ç—ã</h3>
        <button id="clearLog">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <button id="fullDiagnostic">üî¨ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
      </div>

      <div id="endpointInfo" class="endpoint-info" style="display: none;">
        <h4>üîó Endpoint –ø–æ–¥–ø–∏—Å–∫–∏:</h4>
        <div id="endpointText"></div>
        <h4>üîë –ö–ª—é—á–∏:</h4>
        <div id="keysText"></div>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      const log = document.getElementById("log");
      const status = document.getElementById("status");
      const endpointInfo = document.getElementById("endpointInfo");
      const endpointText = document.getElementById("endpointText");
      const keysText = document.getElementById("keysText");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logEntry.style.color = type === "error" ? "#FF3B30" : type === "success" ? "#34C759" : type === "warning" ? "#FF9500" : "#007AFF";
        log.appendChild(logEntry);
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message, type = "warning") {
        status.textContent = message;
        status.className = type;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      function checkEnvironment() {
        addLog("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ...");
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMac = /Macintosh/.test(navigator.userAgent);
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
        const isStandalone = window.navigator.standalone || false;
        const hasServiceWorker = 'serviceWorker' in navigator;
        const hasPushManager = 'PushManager' in window;
        const hasNotification = 'Notification' in window;
        
        addLog(`üçé iOS: ${isIOS ? "‚úÖ" : "‚ùå"}`);
        addLog(`üçé Mac: ${isMac ? "‚úÖ" : "‚ùå"}`);
        addLog(`üåê Safari: ${isSafari ? "‚úÖ" : "‚ùå"}`);
        addLog(`üì± PWA —Ä–µ–∂–∏–º: ${isStandalone ? "‚úÖ" : "‚ùå"}`);
        addLog(`‚öôÔ∏è Service Worker: ${hasServiceWorker ? "‚úÖ" : "‚ùå"}`);
        addLog(`üöÄ Push Manager: ${hasPushManager ? "‚úÖ" : "‚ùå"}`);
        addLog(`üîî Notifications: ${hasNotification ? "‚úÖ" : "‚ùå"}`);
        
        // –ù–∞ Mac Safari push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ PWA —Ä–µ–∂–∏–º–∞
        if (isSafari && hasServiceWorker && hasPushManager && hasNotification && (isIOS || isMac)) {
          addLog("‚úÖ –í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–ª—è Safari push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π", "success");
          updateStatus("–û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è Safari ‚úÖ", "success");
          return true;
        } else {
          addLog("‚ùå –ù–µ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã", "error");
          updateStatus("–û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –≥–æ—Ç–æ–≤–æ ‚ùå", "error");
          return false;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ PWA —Ä–µ–∂–∏–º–∞
      function checkPWA() {
        addLog("üì± –ü—Ä–æ–≤–µ—Ä—è–µ–º PWA —Ä–µ–∂–∏–º...");
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMac = /Macintosh/.test(navigator.userAgent);
        const isStandalone = window.navigator.standalone || false;
        
        if (isStandalone) {
          addLog("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ PWA —Ä–µ–∂–∏–º–µ", "success");
          addLog("üì± –ó–∞–ø—É—â–µ–Ω–æ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞", "success");
        } else {
          if (isMac) {
            addLog("‚ÑπÔ∏è –ù–∞ Mac Safari push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ PWA —Ä–µ–∂–∏–º–∞", "info");
          } else {
            addLog("‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ù–ï –≤ PWA —Ä–µ–∂–∏–º–µ", "error");
            addLog("üí° –î–æ–±–∞–≤—å—Ç–µ —Å–∞–π—Ç –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç—Ç—É–¥–∞", "warning");
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º display mode
        if (window.matchMedia('(display-mode: standalone)').matches) {
          addLog("‚úÖ Display mode: standalone", "success");
        } else {
          if (isMac) {
            addLog("‚ÑπÔ∏è –ù–∞ Mac Safari display mode –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω", "info");
          } else {
            addLog("‚ùå Display mode: –Ω–µ standalone", "error");
          }
        }
        
        return isStandalone;
      }

      // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
      async function createSubscription() {
        addLog("üöÄ –°–æ–∑–¥–∞–µ–º push-–ø–æ–¥–ø–∏—Å–∫—É...");
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMac = /Macintosh/.test(navigator.userAgent);
        
        // –ù–∞ Mac Safari –Ω–µ –Ω—É–∂–µ–Ω PWA —Ä–µ–∂–∏–º
        if (isMac) {
          addLog("üçé Mac Safari - PWA —Ä–µ–∂–∏–º –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è", "info");
        } else if (!checkEnvironment()) {
          addLog("‚ùå –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –≥–æ—Ç–æ–≤–æ", "error");
          return;
        }
        
        try {
          const registration = await navigator.serviceWorker.ready;
          
          // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
          const existingSubscription = await registration.pushManager.getSubscription();
          if (existingSubscription) {
            addLog("üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É...");
            await existingSubscription.unsubscribe();
          }
          
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
          addLog("üîë –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É...");
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º VAPID –∫–ª—é—á –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
          const vapidKey = "BPmb6CQrFMWqBD3sNNE9AZ0iBoKHXNZMSiXQh4t_PJ9qxpH97GT1iIbnrPnnDiMx3dsMQFJSlOIuw8kkhwAeZXU";
          addLog("üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º VAPID –∫–ª—é—á –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞", "success");
          
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidKey),
          });
          
          addLog("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!", "success");
          addLog(`üîó Endpoint: ${subscription.endpoint.substring(0, 80)}...`);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø endpoint
          if (subscription.endpoint.includes('web.push.apple.com')) {
            addLog("üçé APNS endpoint —Å–æ–∑–¥–∞–Ω! Safari –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "success");
            updateStatus("APNS –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! ‚úÖ", "success");
          } else if (subscription.endpoint.includes('fcm.googleapis.com')) {
            addLog("‚ö†Ô∏è FCM endpoint —Å–æ–∑–¥–∞–Ω. Safari –ù–ï –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "warning");
            updateStatus("FCM –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–Ω–µ –¥–ª—è Safari) ‚ö†Ô∏è", "warning");
          } else {
            addLog("‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π endpoint —Ç–∏–ø", "error");
            updateStatus("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π endpoint ‚ùì", "error");
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ
          showSubscriptionInfo(subscription);
          
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, "error");
          updateStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ‚ùå", "error");
        }
      }

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ APNS –ø–æ–¥–ø–∏—Å–∫–∏
      async function forceAPNS() {
        addLog("üçé –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º APNS –ø–æ–¥–ø–∏—Å–∫—É...");
        
        if (!checkEnvironment()) {
          addLog("‚ùå –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –≥–æ—Ç–æ–≤–æ", "error");
          return;
        }
        
        try {
          const registration = await navigator.serviceWorker.ready;
          
          // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
          const existingSubscription = await registration.pushManager.getSubscription();
          if (existingSubscription) {
            addLog("üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É...");
            await existingSubscription.unsubscribe();
          }
          
          // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
          let attempts = 0;
          const maxAttempts = 5;
          
          while (attempts < maxAttempts) {
            attempts++;
            addLog(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts} —Å–æ–∑–¥–∞–Ω–∏—è APNS –ø–æ–¥–ø–∏—Å–∫–∏...`);
            
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º VAPID –∫–ª—é—á –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
              const vapidKey = "BPmb6CQrFMWqBD3sNNE9AZ0iBoKHXNZMSiXQh4t_PJ9qxpH97GT1iIbnrPnnDiMx3dsMQFJSlOIuw8kkhwAeZXU";
              
              const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidKey),
              });
              
              if (subscription.endpoint.includes('web.push.apple.com')) {
                addLog("üçé –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ APNS –ø–æ–¥–ø–∏—Å–∫–∞!", "success");
                updateStatus("APNS –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! ‚úÖ", "success");
                showSubscriptionInfo(subscription);
                return;
              } else {
                addLog(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${attempts}: —Å–æ–∑–¥–∞–Ω ${subscription.endpoint.includes('fcm.googleapis.com') ? 'FCM' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} endpoint`);
                await subscription.unsubscribe();
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            } catch (error) {
              addLog(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ ${attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å: ${error.message}`);
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          }
          
          addLog("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å APNS –ø–æ–¥–ø–∏—Å–∫—É –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫", "error");
          updateStatus("APNS –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ ‚ùå", "error");
          
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è APNS: ${error.message}`, "error");
        }
      }

      // –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
      async function clearSubscription() {
        addLog("üóëÔ∏è –û—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É...");
        
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          
          if (subscription) {
            await subscription.unsubscribe();
            addLog("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞", "success");
            endpointInfo.style.display = "none";
          } else {
            addLog("‚ÑπÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", "info");
          }
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, "error");
        }
      }

      // –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ
      function showSubscriptionInfo(subscription) {
        endpointInfo.style.display = "block";
        endpointText.textContent = subscription.endpoint;
        
        const keys = subscription.toJSON().keys;
        if (keys) {
          keysText.innerHTML = `
            <strong>P256DH:</strong> ${keys.p256dh}<br>
            <strong>Auth:</strong> ${keys.auth}
          `;
        } else {
          keysText.textContent = "–ö–ª—é—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã";
        }
      }

      // –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      function testNotification() {
        addLog("üîî –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...");
        
        if (Notification.permission !== "granted") {
          addLog("‚ùå –ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "error");
          return;
        }
        
        try {
          const notification = new Notification("Safari Push –¢–µ—Å—Ç", {
            body: "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Safari",
            icon: "/icons/icon192.png",
            badge: "/icons/icon192.png",
            tag: "safari-test",
            requireInteraction: false
          });
          
          addLog("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ", "success");
          
          notification.onclick = () => {
            addLog("üëÜ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–∫–Ω—É—Ç–æ");
            window.focus();
          };
          
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`, "error");
        }
      }

      // –¢–µ—Å—Ç Push —á–µ—Ä–µ–∑ Service Worker
      async function testPush() {
        addLog("üöÄ –¢–µ—Å—Ç–∏—Ä—É–µ–º Push —á–µ—Ä–µ–∑ Service Worker...");
        
        try {
          const registration = await navigator.serviceWorker.ready;
          
          if (!registration.active) {
            addLog("‚ùå Service Worker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω", "error");
            return;
          }
          
          const messageChannel = new MessageChannel();
          
          messageChannel.port1.onmessage = (event) => {
            if (event.data.success) {
              addLog("‚úÖ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ", "success");
            } else {
              addLog(`‚ùå –û—à–∏–±–∫–∞ Push: ${event.data.error}`, "error");
            }
          };
          
          registration.active.postMessage({
            type: "TEST_PUSH",
            data: {
              title: "Safari Push –¢–µ—Å—Ç",
              body: "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è Safari",
              icon: "/icons/icon192.png",
              badge: "/icons/icon192.png",
              tag: "safari-push-test"
            }
          }, [messageChannel.port2]);
          
          addLog("üì§ Push-—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ SW");
          
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ Push: ${error.message}`, "error");
        }
      }

      // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
      async function fullDiagnostic() {
        addLog("üî¨ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        const envOk = checkEnvironment();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º PWA
        const pwaOk = checkPWA();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            addLog(`‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${registration.scope}`);
            addLog(`üì± –ê–∫—Ç–∏–≤–Ω—ã–π: ${registration.active ? "–î–∞" : "–ù–µ—Ç"}`);
          } else {
            addLog("‚ùå SW –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
          }
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ SW: ${error.message}`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          
          if (subscription) {
            addLog("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞");
            addLog(`üîó Endpoint: ${subscription.endpoint.substring(0, 60)}...`);
            
            if (subscription.endpoint.includes('web.push.apple.com')) {
              addLog("üçé APNS endpoint - Safari –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å", "success");
            } else if (subscription.endpoint.includes('fcm.googleapis.com')) {
              addLog("‚ö†Ô∏è FCM endpoint - Safari –ù–ï –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å", "warning");
            }
          } else {
            addLog("‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          }
        } catch (error) {
          addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`);
        }
        
        addLog("‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
      }

      // –£—Ç–∏–ª–∏—Ç—ã
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById("checkEnvironment").addEventListener("click", checkEnvironment);
      document.getElementById("checkPWA").addEventListener("click", checkPWA);
      document.getElementById("createSubscription").addEventListener("click", createSubscription);
      document.getElementById("forceAPNS").addEventListener("click", forceAPNS);
      document.getElementById("clearSubscription").addEventListener("click", clearSubscription);
      document.getElementById("testNotification").addEventListener("click", testNotification);
      document.getElementById("testPush").addEventListener("click", testPush);
      document.getElementById("fullDiagnostic").addEventListener("click", fullDiagnostic);
      document.getElementById("clearLog").addEventListener("click", () => {
        log.innerHTML = "";
        addLog("üßπ –õ–æ–≥ –æ—á–∏—â–µ–Ω");
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("load", () => {
        addLog("üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
        checkEnvironment();
        checkPWA();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
      navigator.serviceWorker.addEventListener("message", (event) => {
        addLog(`üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç SW: ${JSON.stringify(event.data)}`);
      });
    </script>
  </body>
</html>
