# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

## üéØ –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç **–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–æ —Ü–µ–ª–æ–µ.

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–æ (–±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π):

```typescript
// –ü—Ä–æ–±–ª–µ–º–∞: –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ –Ω–∞ —à–∞–≥–µ 2, –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω—É—Ç –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–º–∏
await findOrCreateUserStep(userTraining.id, stepLink.id, status); // ‚úÖ –í—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å
await updateUserTrainingStatus(userTraining.id, stepsCount, courseId); // ‚ùå –û—à–∏–±–∫–∞!
await updateUserCourseStartedAt(userId, courseId); // ‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å
```

### –ü–æ—Å–ª–µ (—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏):

```typescript
// –†–µ—à–µ–Ω–∏–µ: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const result = await prisma.$transaction(async (tx) => {
  await findOrCreateUserStepWithTx(tx, userTraining.id, stepLink.id, status);
  await updateUserTrainingStatusWithTx(tx, userTraining.id, stepsCount, courseId);
  await updateUserCourseStartedAtWithTx(tx, userId, courseId);
  return { success: true };
});
// –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

## üìÅ –§–∞–π–ª—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

### 1. `updateUserStepStatus.ts`

- **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —à–∞–≥–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–Ω—è
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
- **–í–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—É—Ä—Å–∞

### 2. `startUserStepServerAction.ts`

- **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –ó–∞–ø—É—Å–∫–∞–µ—Ç —à–∞–≥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è**: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à–∞–≥–µ
- **–í–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ
- –ù–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**

- –î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—é—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–º–∏
- –ù–µ—Ç "–±–∏—Ç—ã—Ö" —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –±–∞–∑–µ

### ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions

### ‚úÖ **–û—Ç–ª–∞–¥–∫–∞**

- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é `updateUserTrainingStatusWithTx`:

```typescript
console.log("üîç updateUserTrainingStatusWithTx:", {
  userTrainingId,
  trainingDayStepsCount,
  userStepsCount: userSteps.length,
  allCompleted,
  stepStatuses: userSteps.map((s) => s.status),
  nextCurrentStepIndex,
});
```

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —à–∞–≥–∞:

```typescript
// 1. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —à–∞–≥–∞
// 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –≤—Å–µ –ª–∏ —à–∞–≥–∏ –¥–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã
// 3. –ï—Å–ª–∏ –¥–∞ - —Å—Ç–∞—Ç—É—Å –¥–Ω—è –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ COMPLETED
// 4. –ï—Å–ª–∏ –Ω–µ—Ç - —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è IN_PROGRESS
// 5. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–Ω—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫—É—Ä—Å–∞
```

### –ó–∞–ø—É—Å–∫ —à–∞–≥–∞:

```typescript
// 1. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∞–≥–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
// 2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —à–∞–≥–∞ (—Ç–æ–∂–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
// 3. –°–æ–∑–¥–∞—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã** (push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –æ—á–µ—Ä–µ–¥–∏) –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
2. **–î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—É—Ä—Å–∞) –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç graceful degradation

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

1. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏ –¥–Ω—è
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –¥–Ω—è –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ COMPLETED
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫—É—Ä—Å —Ç–∞–∫–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è (–µ—Å–ª–∏ –≤—Å–µ –¥–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã)
